<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Referral Management - Panda Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #fafbfc;
            min-height: 100vh;
            color: #374151;
            font-weight: 400;
        }
        .main-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            overflow: hidden;
            max-width: 1600px;
            margin: 20px auto;
            border: 1px solid #f3f4f6;
        }
        .utility-nav {
            background: white;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 24px;
            border-bottom: 1px solid #f3f4f6;
        }
        .nav-links {
            display: flex;
            gap: 4px;
            flex: 1;
        }
        .nav-link {
            color: #6b7280;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.15s ease;
            font-weight: 400;
            font-size: 14px;
        }
        .nav-link:hover {
            background: #f9fafb;
            color: #374151;
            text-decoration: none;
        }
        .nav-link.active {
            background: #3b82f6;
            color: white;
            text-decoration: none;
            font-weight: 500;
        }
        .header {
            background: linear-gradient(135deg, #f8fafc 0%, #e5e7eb 100%);
            color: #374151;
            padding: 32px 40px;
            border-bottom: 1px solid #f3f4f6;
        }
        .logo img { height: 40px; }
        .header h1 {
            margin: 16px 0 8px 0;
            font-size: 28px;
            font-weight: 600;
            color: #111827;
        }
        .header p {
            color: #6b7280;
            margin-bottom: 0;
            font-size: 16px;
            font-weight: 400;
        }
        .content-area {
            padding: 32px 40px;
            background: white;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }
        .stat-card {
            background: white;
            border: 1px solid #f3f4f6;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.15s ease;
        }
        .stat-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-color: #e5e7eb;
        }
        .stat-label {
            color: #6b7280;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }
        .stat-value {
            font-size: 32px;
            font-weight: 600;
            color: #111827;
            margin: 8px 0;
        }
        .stat-icon {
            font-size: 24px;
            opacity: 0.2;
            float: right;
        }
        .tabs {
            display: flex;
            gap: 4px;
            border-bottom: 1px solid #f3f4f6;
            margin-bottom: 24px;
        }
        .tab {
            padding: 12px 24px;
            border: none;
            background: none;
            color: #6b7280;
            font-size: 14px;
            font-weight: 400;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.15s ease;
        }
        .tab:hover {
            color: #374151;
        }
        .tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
            font-weight: 500;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .table {
            font-size: 14px;
        }
        .table th {
            background: #fafbfc;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        .table th:hover {
            background: #f3f4f6;
        }
        .table th.sortable::after {
            content: '\f0dc';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            margin-left: 8px;
            opacity: 0.3;
        }
        .table th.sort-asc::after {
            content: '\f0de';
            opacity: 1;
            color: #3b82f6;
        }
        .table th.sort-desc::after {
            content: '\f0dd';
            opacity: 1;
            color: #3b82f6;
        }
        .table td {
            border-bottom: 1px solid #f3f4f6;
        }
        .badge {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 400;
        }
        .btn {
            font-weight: 400;
            border-radius: 8px;
            transition: all 0.15s ease;
            font-size: 14px;
        }
        .btn-primary {
            background: #3b82f6;
            border-color: #3b82f6;
        }
        .btn-primary:hover {
            background: #2563eb;
            border-color: #2563eb;
        }
        .btn-success {
            background: #10b981;
            border-color: #10b981;
        }
        .btn-sm {
            padding: 4px 12px;
            font-size: 13px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        .error-message {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #991b1b;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
        }
        .search-box {
            max-width: 400px;
            margin-bottom: 20px;
        }
        .form-control, .form-select {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            transition: all 0.15s ease;
            font-size: 14px;
        }
        .form-control:focus, .form-select:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .modal-content {
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }
        .modal-header {
            border-bottom: 1px solid #f3f4f6;
            background: #fafbfc;
        }
        .toolbar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        .toolbar-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .tier-config {
            background: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .tier-row {
            display: grid;
            grid-template-columns: 150px 150px 150px 1fr auto;
            gap: 12px;
            align-items: center;
            margin-bottom: 12px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Navigation -->
        <div class="utility-nav">
            <div class="nav-links">
                <a href="./employee.html" class="nav-link">üë• Employees</a>
                <a href="./points.html" class="nav-link">‚≠ê Points</a>
                <a href="./leads.html" class="nav-link active">üìä Leads</a>
                <a href="./referrals.html" class="nav-link">ü§ù Referrals</a>
                <a href="./assets.html" class="nav-link">üì¶ Assets</a>
                <a href="./admin.html" class="nav-link">‚öôÔ∏è Admin</a>
            </div>
        </div>

        <!-- Header -->
        <div class="header">
            <div class="logo">
                <img src="https://pandaexteriors.com/wp-content/uploads/2023/09/cropped-Panda-Logo-Main-3.png" alt="Panda Exteriors">
            </div>
            <h1>Referral Management</h1>
            <p>Track advocates, leads, and commission payments to advocates - Now with 1,849 advocates!</p>
        </div>

        <!-- Content -->
        <div class="content-area">
            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="loading">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
                <p class="mt-3">Loading referral data...</p>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="error-message" style="display: none;">
                <strong>Error:</strong> <span id="errorText"></span>
            </div>

            <!-- Dashboard Stats -->
            <div id="dashboardStats" style="display: none;">
                <div class="stats-grid">
                    <div class="stat-card">
                        <i class="fas fa-users stat-icon"></i>
                        <div class="stat-label">Total Advocates</div>
                        <div class="stat-value" id="totalAdvocates">0</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-user-check stat-icon"></i>
                        <div class="stat-label">Active Advocates</div>
                        <div class="stat-value" id="activeAdvocates">0</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-clipboard-list stat-icon"></i>
                        <div class="stat-label">Total Leads</div>
                        <div class="stat-value" id="totalLeads">0</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-check-circle stat-icon"></i>
                        <div class="stat-label">Qualified Leads</div>
                        <div class="stat-value" id="qualifiedLeads">0</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-dollar-sign stat-icon"></i>
                        <div class="stat-label">Total Paid Out</div>
                        <div class="stat-value" id="totalEarnings">$0</div>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('advocates')">
                        <i class="fas fa-users"></i> Advocates (1,849)
                    </button>
                    <button class="tab" onclick="switchTab('leads')">
                        <i class="fas fa-clipboard-list"></i> Leads
                    </button>
                    <button class="tab" onclick="switchTab('payouts')">
                        <i class="fas fa-money-bill-wave"></i> Payments to Advocates
                    </button>
                    <button class="tab" onclick="switchTab('settings')">
                        <i class="fas fa-cog"></i> Tier Settings
                    </button>
                </div>

                <!-- Advocates Tab -->
                <div id="advocatesTab" class="tab-content active">
                    <div class="toolbar">
                        <input type="text" class="form-control search-box" id="advocateSearch" placeholder="Search advocates..." onkeyup="filterAdvocates()">
                        <button class="btn btn-primary toolbar-btn" onclick="exportToCSV('advocates')">
                            <i class="fas fa-download"></i> Export CSV
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover" id="advocatesTable">
                            <thead>
                                <tr>
                                    <th class="sortable" onclick="sortTable('advocates', 'name')">Name</th>
                                    <th class="sortable" onclick="sortTable('advocates', 'email')">Email</th>
                                    <th class="sortable" onclick="sortTable('advocates', 'referralCode')">Referral Code</th>
                                    <th class="sortable" onclick="sortTable('advocates', 'totalReferrals')">Total Referrals</th>
                                    <th class="sortable" onclick="sortTable('advocates', 'totalEarnings')">Total Commissions Earned</th>
                                    <th class="sortable" onclick="sortTable('advocates', 'repName')">Sales Rep</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="advocatesTableBody">
                                <tr><td colspan="7" class="text-center">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="advocatePagination" class="mt-3 text-center"></div>
                </div>

                <!-- Leads Tab -->
                <div id="leadsTab" class="tab-content">
                    <div class="toolbar">
                        <input type="text" class="form-control search-box" id="leadSearch" placeholder="Search leads..." onkeyup="filterLeads()">
                        <button class="btn btn-primary toolbar-btn" onclick="exportToCSV('leads')">
                            <i class="fas fa-download"></i> Export CSV
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover" id="leadsTable">
                            <thead>
                                <tr>
                                    <th class="sortable" onclick="sortTable('leads', 'name')">Name</th>
                                    <th class="sortable" onclick="sortTable('leads', 'phone')">Phone</th>
                                    <th class="sortable" onclick="sortTable('leads', 'advocateName')">Advocate</th>
                                    <th class="sortable" onclick="sortTable('leads', 'status')">Status</th>
                                    <th class="sortable" onclick="sortTable('leads', 'product')">Product</th>
                                    <th class="sortable" onclick="sortTable('leads', 'territory')">Territory</th>
                                    <th class="sortable" onclick="sortTable('leads', 'createdAt')">Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="leadsTableBody">
                                <tr><td colspan="8" class="text-center">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Payouts Tab -->
                <div id="payoutsTab" class="tab-content">
                    <div class="toolbar">
                        <button class="btn btn-success toolbar-btn" onclick="processPayouts()">
                            <i class="fas fa-credit-card"></i> Approve Pending Payments
                        </button>
                        <button class="btn btn-primary toolbar-btn" onclick="exportToCSV('payouts')">
                            <i class="fas fa-download"></i> Export CSV
                        </button>
                        <select class="form-select" style="width: 200px;" id="payoutStatusFilter" onchange="filterPayouts()">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="paid">Paid</option>
                        </select>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover" id="payoutsTable">
                            <thead>
                                <tr>
                                    <th class="sortable" onclick="sortTable('payouts', 'advocateName')">Pay To (Advocate)</th>
                                    <th class="sortable" onclick="sortTable('payouts', 'tier')">Commission Tier</th>
                                    <th class="sortable" onclick="sortTable('payouts', 'amount')">Amount Due</th>
                                    <th class="sortable" onclick="sortTable('payouts', 'product')">Product</th>
                                    <th class="sortable" onclick="sortTable('payouts', 'territory')">Territory</th>
                                    <th class="sortable" onclick="sortTable('payouts', 'status')">Payment Status</th>
                                    <th class="sortable" onclick="sortTable('payouts', 'createdAt')">Date Earned</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="payoutsTableBody">
                                <tr><td colspan="8" class="text-center">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="settingsTab" class="tab-content">
                    <h3 class="mb-4">Commission Tier Configuration</h3>
                    <p class="text-muted">Configure commission amounts paid TO advocates based on referral stage, product type, and territory</p>

                    <div class="tier-config">
                        <h5>Commission Tiers (Amount Paid to Advocate)</h5>
                        <p class="text-muted small mb-3">Current GTR Product Tiers:</p>

                        <!-- Roofing/Siding -->
                        <div class="mb-4">
                            <h6 class="text-primary">Roofing/Siding</h6>
                            <div class="tier-row">
                                <div><strong>Stage</strong></div>
                                <div><strong>Territory</strong></div>
                                <div><strong>Amount</strong></div>
                                <div><strong>Bonus</strong></div>
                                <div></div>
                            </div>
                            <div class="tier-row">
                                <input type="text" class="form-control" value="Verified (Qualified)" readonly>
                                <input type="text" class="form-control" value="All States" readonly>
                                <input type="number" class="form-control" value="50" step="1">
                                <input type="text" class="form-control" value="-" readonly>
                                <button class="btn btn-sm btn-success" onclick="saveTierConfig('roofing', 'verified')">Save</button>
                            </div>
                            <div class="tier-row">
                                <input type="text" class="form-control" value="Sold" readonly>
                                <input type="text" class="form-control" value="All States" readonly>
                                <input type="number" class="form-control" value="150" step="1">
                                <input type="text" class="form-control" value="$200 after 3 sold" readonly>
                                <button class="btn btn-sm btn-success" onclick="saveTierConfig('roofing', 'sold')">Save</button>
                            </div>
                        </div>

                        <!-- Solar -->
                        <div class="mb-4">
                            <h6 class="text-primary">Solar</h6>
                            <div class="tier-row">
                                <input type="text" class="form-control" value="Verified (Qualified)" readonly>
                                <input type="text" class="form-control" value="All States" readonly>
                                <input type="number" class="form-control" value="50" step="1">
                                <input type="text" class="form-control" value="-" readonly>
                                <button class="btn btn-sm btn-success" onclick="saveTierConfig('solar', 'verified')">Save</button>
                            </div>
                            <div class="tier-row">
                                <input type="text" class="form-control" value="Sold" readonly>
                                <input type="text" class="form-control" value="All States" readonly>
                                <input type="number" class="form-control" value="150" step="1">
                                <input type="text" class="form-control" value="$200 after 3 sold" readonly>
                                <button class="btn btn-sm btn-success" onclick="saveTierConfig('solar', 'sold')">Save</button>
                            </div>
                        </div>

                        <!-- Bath -->
                        <div class="mb-4">
                            <h6 class="text-primary">Bath</h6>
                            <p class="small text-muted">Available only in Delaware, New Jersey, and Pennsylvania</p>
                            <div class="tier-row">
                                <input type="text" class="form-control" value="Verified (Qualified)" readonly>
                                <input type="text" class="form-control" value="DE, NJ, PA only" readonly>
                                <input type="number" class="form-control" value="50" step="1">
                                <input type="text" class="form-control" value="-" readonly>
                                <button class="btn btn-sm btn-success" onclick="saveTierConfig('bath', 'verified')">Save</button>
                            </div>
                            <div class="tier-row">
                                <input type="text" class="form-control" value="Sold" readonly>
                                <input type="text" class="form-control" value="DE, NJ, PA only" readonly>
                                <input type="number" class="form-control" value="250" step="1">
                                <input type="text" class="form-control" value="N/A" readonly>
                                <button class="btn btn-sm btn-success" onclick="saveTierConfig('bath', 'sold')">Save</button>
                            </div>
                        </div>

                        <!-- Advocate SalesRep -->
                        <div class="mb-4">
                            <h6 class="text-primary">Advocate SalesRep Product</h6>
                            <p class="small text-muted">For sales rep advocate referrals</p>
                            <div class="tier-row">
                                <input type="text" class="form-control" value="Signup" readonly>
                                <input type="text" class="form-control" value="All States" readonly>
                                <input type="number" class="form-control" value="25" step="1">
                                <input type="text" class="form-control" value="-" readonly>
                                <button class="btn btn-sm btn-success" onclick="saveTierConfig('salesrep', 'signup')">Save</button>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <button class="btn btn-primary" onclick="loadTierConfigs()">
                            <i class="fas fa-sync"></i> Reload Configurations
                        </button>
                        <button class="btn btn-success" onclick="saveAllTierConfigs()">
                            <i class="fas fa-save"></i> Save All Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payout Modal -->
    <div class="modal fade" id="payoutModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Process Commission Payment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3">This is a payment going <strong>TO</strong> the advocate for earned commissions.</p>
                    <div class="mb-3">
                        <label class="form-label">Pay To (Advocate)</label>
                        <input type="text" class="form-control" id="payoutAdvocateName" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Amount to Pay</label>
                        <input type="text" class="form-control" id="payoutAmount" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Payment Status</label>
                        <select class="form-select" id="payoutStatus">
                            <option value="pending">Pending - Not yet approved</option>
                            <option value="approved">Approved - Ready to send payment</option>
                            <option value="paid">Paid - Payment sent to advocate</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Payment Notes</label>
                        <textarea class="form-control" id="payoutNotes" rows="3" placeholder="Check number, Venmo ID, etc."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="updatePayoutStatus()">Update Payment Status</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // API Configuration
        const API_BASE = 'https://7paaginnvg.execute-api.us-east-2.amazonaws.com/prod/referrals';

        // Global data storage
        let appData = {
            advocates: [],
            leads: [],
            payouts: [],
            advocatesMap: new Map(),
            sortState: {},
            currentPage: 1,
            pageSize: 50,
            tierConfigs: []
        };

        // Current payout being edited
        let currentPayout = null;

        // Initialize app on page load
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Page loaded, fetching data...');
            await loadAllData();
            await loadTierConfigs();
        });

        // Load all data from API
        async function loadAllData() {
            try {
                showLoading(true);
                console.log('Fetching from:', API_BASE);

                // Load dashboard data
                const dashboardRes = await fetch(`${API_BASE}/dashboard`);
                console.log('Dashboard response status:', dashboardRes.status);
                const dashboard = await dashboardRes.json();
                console.log('Dashboard data:', dashboard);

                // Load stats
                const statsRes = await fetch(`${API_BASE}/stats`);
                const stats = await statsRes.json();
                console.log('Stats data:', stats);

                // Load sales reps
                const repsRes = await fetch(`${API_BASE}/reps`);
                const reps = await repsRes.json();
                console.log('Reps data:', reps);

                // Store data
                appData.advocates = dashboard.advocates || [];
                appData.leads = dashboard.leads || [];
                appData.payouts = dashboard.payouts || [];
                appData.stats = stats;

                // Create maps for quick lookup
                appData.advocatesMap = new Map(appData.advocates.map(a => [a.advocateId, a]));

                console.log('Data loaded:', {
                    advocates: appData.advocates.length,
                    leads: appData.leads.length,
                    payouts: appData.payouts.length
                });

                // Update UI
                updateDashboardStats();
                renderAdvocatesTable();
                renderLeadsTable();
                renderPayoutsTable();

                showLoading(false);

            } catch (error) {
                console.error('Error loading data:', error);
                showError('Failed to load data: ' + error.message);
                showLoading(false);
            }
        }

        // Show/hide loading indicator
        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
            document.getElementById('dashboardStats').style.display = show ? 'none' : 'block';
        }

        // Show error message
        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
        }

        // Update dashboard stats
        function updateDashboardStats() {
            const stats = appData.stats || {};
            document.getElementById('totalAdvocates').textContent = appData.advocates.length;
            document.getElementById('activeAdvocates').textContent = appData.advocates.filter(a => a.active !== false).length;
            document.getElementById('totalLeads').textContent = appData.leads.length;
            document.getElementById('qualifiedLeads').textContent = appData.leads.filter(l => l.status === 'qualified').length;
            document.getElementById('totalEarnings').textContent = '$' + (stats.totalEarnings || 0).toLocaleString();
        }

        // Sorting function
        function sortTable(table, column) {
            const currentSort = appData.sortState[table] || {};
            const isAsc = currentSort.column === column && currentSort.direction === 'asc';

            appData.sortState[table] = {
                column: column,
                direction: isAsc ? 'desc' : 'asc'
            };

            // Update table headers
            const headers = document.querySelectorAll(`#${table}Table th`);
            headers.forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });

            const clickedHeader = event.target;
            clickedHeader.classList.add(isAsc ? 'sort-desc' : 'sort-asc');

            // Sort the data
            const dataArray = appData[table];
            dataArray.sort((a, b) => {
                let aVal, bVal;

                if (column === 'name') {
                    aVal = `${a.firstName || ''} ${a.lastName || ''}`.trim().toLowerCase();
                    bVal = `${b.firstName || ''} ${b.lastName || ''}`.trim().toLowerCase();
                } else if (column === 'advocateName') {
                    const advA = appData.advocatesMap.get(a.advocateId);
                    const advB = appData.advocatesMap.get(b.advocateId);
                    aVal = advA ? `${advA.firstName} ${advA.lastName}`.toLowerCase() : '';
                    bVal = advB ? `${advB.firstName} ${advB.lastName}`.toLowerCase() : '';
                } else {
                    aVal = a[column] || '';
                    bVal = b[column] || '';
                }

                if (typeof aVal === 'string') {
                    return isAsc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                } else {
                    return isAsc ? aVal - bVal : bVal - aVal;
                }
            });

            // Re-render the table
            if (table === 'advocates') renderAdvocatesTable();
            else if (table === 'leads') renderLeadsTable();
            else if (table === 'payouts') renderPayoutsTable();
        }

        // Render advocates table with pagination
        function renderAdvocatesTable() {
            const tbody = document.getElementById('advocatesTableBody');
            const start = (appData.currentPage - 1) * appData.pageSize;
            const end = start + appData.pageSize;
            const pageData = appData.advocates.slice(start, end);

            if (!pageData.length) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No advocates found</td></tr>';
                return;
            }

            tbody.innerHTML = pageData.map(adv => {
                const name = `${adv.firstName || ''} ${adv.lastName || ''}`.trim() || 'N/A';
                const leadsCount = appData.leads.filter(l => l.advocateId === adv.advocateId).length;
                return `
                    <tr>
                        <td>${name}</td>
                        <td>${adv.email || 'N/A'}</td>
                        <td><code>${adv.referralCode || 'N/A'}</code></td>
                        <td>${leadsCount}</td>
                        <td>$${(adv.totalEarnings || 0).toFixed(2)}</td>
                        <td>${adv.repName || 'Unassigned'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="viewAdvocate('${adv.advocateId}')">
                                View
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            // Render pagination
            renderPagination();
        }

        // Render pagination
        function renderPagination() {
            const totalPages = Math.ceil(appData.advocates.length / appData.pageSize);
            const pagination = document.getElementById('advocatePagination');

            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = '<nav><ul class="pagination justify-content-center">';

            // Previous button
            html += `<li class="page-item ${appData.currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${appData.currentPage - 1}); return false;">Previous</a>
            </li>`;

            // Page numbers
            for (let i = 1; i <= Math.min(totalPages, 10); i++) {
                html += `<li class="page-item ${i === appData.currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
                </li>`;
            }

            if (totalPages > 10) {
                html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }

            // Next button
            html += `<li class="page-item ${appData.currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${appData.currentPage + 1}); return false;">Next</a>
            </li>`;

            html += '</ul></nav>';
            html += `<p class="text-muted">Showing ${((appData.currentPage - 1) * appData.pageSize) + 1} to ${Math.min(appData.currentPage * appData.pageSize, appData.advocates.length)} of ${appData.advocates.length} advocates</p>`;
            pagination.innerHTML = html;
        }

        // Change page
        function changePage(page) {
            const totalPages = Math.ceil(appData.advocates.length / appData.pageSize);
            if (page < 1 || page > totalPages) return;
            appData.currentPage = page;
            renderAdvocatesTable();
        }

        // Filter advocates
        function filterAdvocates() {
            const search = document.getElementById('advocateSearch').value.toLowerCase();
            const filtered = appData.advocates.filter(adv => {
                const name = `${adv.firstName} ${adv.lastName}`.toLowerCase();
                const email = (adv.email || '').toLowerCase();
                const code = (adv.referralCode || '').toLowerCase();
                return name.includes(search) || email.includes(search) || code.includes(search);
            });

            // Temporarily replace advocates array
            const original = appData.advocates;
            appData.advocates = filtered;
            appData.currentPage = 1;
            renderAdvocatesTable();
            appData.advocates = original;
        }

        // Render leads table
        function renderLeadsTable() {
            const tbody = document.getElementById('leadsTableBody');
            if (!appData.leads.length) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No leads found</td></tr>';
                return;
            }

            tbody.innerHTML = appData.leads.map(lead => {
                const name = `${lead.firstName || ''} ${lead.lastName || ''}`.trim() || 'N/A';
                const advocate = appData.advocatesMap.get(lead.advocateId);
                const advocateName = advocate ? `${advocate.firstName || ''} ${advocate.lastName || ''}`.trim() : 'N/A';
                const createdDate = new Date(lead.createdAt).toLocaleDateString();
                const statusBadge = getStatusBadge(lead.status);
                const territory = lead.address?.state || 'N/A';

                return `
                    <tr>
                        <td>${name}</td>
                        <td>${lead.phone || 'N/A'}</td>
                        <td>${advocateName}</td>
                        <td>${statusBadge}</td>
                        <td>${lead.product || 'N/A'}</td>
                        <td>${territory}</td>
                        <td>${createdDate}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="viewLead('${lead.leadId}')">
                                View
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Filter leads
        function filterLeads() {
            const search = document.getElementById('leadSearch').value.toLowerCase();
            const filtered = appData.leads.filter(lead => {
                const name = `${lead.firstName} ${lead.lastName}`.toLowerCase();
                const phone = (lead.phone || '').toLowerCase();
                return name.includes(search) || phone.includes(search);
            });

            const original = appData.leads;
            appData.leads = filtered;
            renderLeadsTable();
            appData.leads = original;
        }

        // Render payouts table
        function renderPayoutsTable() {
            const tbody = document.getElementById('payoutsTableBody');
            const statusFilter = document.getElementById('payoutStatusFilter')?.value || '';

            let filtered = appData.payouts;
            if (statusFilter) {
                filtered = appData.payouts.filter(p => p.status === statusFilter);
            }

            if (!filtered.length) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No payouts found</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(payout => {
                const advocate = appData.advocatesMap.get(payout.advocateId);
                const advocateName = advocate ? `${advocate.firstName || ''} ${advocate.lastName || ''}`.trim() : 'N/A';
                const date = new Date(payout.createdAt).toLocaleDateString();
                const statusBadge = payout.status === 'paid' ?
                    '<span class="badge bg-success">Paid</span>' :
                    payout.status === 'approved' ?
                    '<span class="badge bg-info">Approved</span>' :
                    '<span class="badge bg-warning">Pending</span>';

                return `
                    <tr>
                        <td>${advocateName}</td>
                        <td>${payout.tier || 'N/A'}</td>
                        <td>$${(payout.amount || 0).toFixed(2)}</td>
                        <td>${payout.product || 'N/A'}</td>
                        <td>${payout.territory || 'N/A'}</td>
                        <td>${statusBadge}</td>
                        <td>${date}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editPayout('${payout.payoutId}')">
                                Edit
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Filter payouts
        function filterPayouts() {
            renderPayoutsTable();
        }

        // Get status badge HTML
        function getStatusBadge(status) {
            const badges = {
                'new': '<span class="badge bg-primary">New</span>',
                'contacted': '<span class="badge bg-info">Contacted</span>',
                'qualified': '<span class="badge bg-success">Qualified</span>',
                'sold': '<span class="badge bg-success">Sold</span>',
                'lost': '<span class="badge bg-danger">Lost</span>'
            };
            return badges[status] || '<span class="badge bg-secondary">Unknown</span>';
        }

        // Switch tabs
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.closest('.tab').classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // Export to CSV
        function exportToCSV(type) {
            let data, filename;

            if (type === 'advocates') {
                data = appData.advocates.map(a => ({
                    Name: `${a.firstName} ${a.lastName}`,
                    Email: a.email,
                    Phone: a.phone,
                    'Referral Code': a.referralCode,
                    'Sales Rep': a.repName,
                    'Total Referrals': a.totalReferrals,
                    'Total Earnings': a.totalEarnings,
                    City: a.address?.city,
                    State: a.address?.state
                }));
                filename = 'advocates.csv';
            } else if (type === 'leads') {
                data = appData.leads.map(l => ({
                    Name: `${l.firstName} ${l.lastName}`,
                    Phone: l.phone,
                    Email: l.email,
                    Status: l.status,
                    Product: l.product,
                    Territory: l.address?.state,
                    Created: new Date(l.createdAt).toLocaleDateString()
                }));
                filename = 'leads.csv';
            } else if (type === 'payouts') {
                data = appData.payouts.map(p => {
                    const adv = appData.advocatesMap.get(p.advocateId);
                    return {
                        Advocate: adv ? `${adv.firstName} ${adv.lastName}` : 'N/A',
                        Tier: p.tier,
                        Amount: p.amount,
                        Product: p.product,
                        Territory: p.territory,
                        Status: p.status,
                        Date: new Date(p.createdAt).toLocaleDateString()
                    };
                });
                filename = 'payouts.csv';
            }

            const csv = convertToCSV(data);
            downloadCSV(csv, filename);
        }

        // Convert array to CSV
        function convertToCSV(data) {
            if (!data.length) return '';
            const headers = Object.keys(data[0]);
            const rows = data.map(row => headers.map(h => JSON.stringify(row[h] || '')).join(','));
            return [headers.join(','), ...rows].join('\n');
        }

        // Download CSV file
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // View advocate details
        function viewAdvocate(advocateId) {
            const advocate = appData.advocatesMap.get(advocateId);
            if (advocate) {
                alert(`Advocate: ${advocate.firstName} ${advocate.lastName}\nEmail: ${advocate.email}\nReferral Code: ${advocate.referralCode}\nTotal Earned: $${advocate.totalEarnings}`);
            }
        }

        // View lead details
        function viewLead(leadId) {
            const lead = appData.leads.find(l => l.leadId === leadId);
            if (lead) {
                alert(`Lead: ${lead.firstName} ${lead.lastName}\nPhone: ${lead.phone}\nStatus: ${lead.status}\nProduct: ${lead.product}`);
            }
        }

        // Edit payout
        function editPayout(payoutId) {
            const payout = appData.payouts.find(p => p.payoutId === payoutId);
            if (!payout) return;

            currentPayout = payout;
            const advocate = appData.advocatesMap.get(payout.advocateId);

            document.getElementById('payoutAdvocateName').value = advocate ? `${advocate.firstName} ${advocate.lastName}` : 'N/A';
            document.getElementById('payoutAmount').value = `$${payout.amount.toFixed(2)}`;
            document.getElementById('payoutStatus').value = payout.status;
            document.getElementById('payoutNotes').value = payout.notes || '';

            const modal = new bootstrap.Modal(document.getElementById('payoutModal'));
            modal.show();
        }

        // Update payout status
        async function updatePayoutStatus() {
            if (!currentPayout) return;

            const newStatus = document.getElementById('payoutStatus').value;
            const notes = document.getElementById('payoutNotes').value;

            try {
                const response = await fetch(`${API_BASE}/payouts/${currentPayout.payoutId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus, notes: notes })
                });

                if (response.ok) {
                    alert('Payout updated successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('payoutModal')).hide();
                    await loadAllData();
                } else {
                    alert('Failed to update payout');
                }
            } catch (error) {
                console.error('Error updating payout:', error);
                alert('Error updating payout');
            }
        }

        // Process pending payouts
        async function processPayouts() {
            const pending = appData.payouts.filter(p => p.status === 'pending');
            if (!pending.length) {
                alert('No pending payouts to process');
                return;
            }

            if (!confirm(`Approve ${pending.length} pending payments to advocates?\n\nThis will mark them as ready to send payment.`)) return;

            try {
                for (const payout of pending) {
                    await fetch(`${API_BASE}/payouts/${payout.payoutId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: 'approved' })
                    });
                }
                alert(`Successfully approved ${pending.length} payments to advocates!`);
                await loadAllData();
            } catch (error) {
                console.error('Error processing payouts:', error);
                alert('Error processing payouts');
            }
        }

        // Load tier configurations
        async function loadTierConfigs() {
            // For now, using default values
            // In production, this would load from DynamoDB or API
            console.log('Tier configurations loaded');
        }

        // Save tier configuration
        function saveTierConfig(product, stage) {
            console.log(`Saving tier config:`, { product, stage });

            // In production, this would POST to the API to save to DynamoDB
            // Example structure:
            // {
            //   product: 'roofing' | 'solar' | 'bath' | 'salesrep',
            //   stage: 'verified' | 'sold' | 'signup',
            //   amount: <value from input>,
            //   territories: ['*'] or ['DE', 'NJ', 'PA']
            // }

            alert(`Configuration saved for ${product} - ${stage}\n\nIn production, this would update DynamoDB tier configuration table.`);
        }

        // Save all tier configurations
        function saveAllTierConfigs() {
            alert('All tier configurations saved!\n\nIn production, this would bulk update all tier amounts in DynamoDB.');
        }
    </script>
</body>
</html>
