let employees=[];let terminatedEmployees=[];let mergedEmployeeIds=new Set(JSON.parse(localStorage.getItem('mergedEmployeeIds')||'[]'));const API_BASE='https://w40mq6ab11.execute-api.us-east-2.amazonaws.com/prod';async function loadEmployees(){try{const response=await fetch(`${API_BASE}/employees`);const data=await response.json();console.log('Raw API response:',data);if(data.employees){let allEmployees=data.employees.filter(emp=>!mergedEmployeeIds.has(emp.employee_id));allEmployees.forEach(emp=>{if(!emp.employee_id&&emp['First Name']&&emp['Last Name']){emp.employee_id=generateEmployeeId(emp['First Name'],emp['Last Name'])}});employees=allEmployees.filter(emp=>emp.Terminated!=='Yes');terminatedEmployees=allEmployees.filter(emp=>emp.Terminated==='Yes');console.log('Active employees:',employees.length);console.log('Terminated employees:',terminatedEmployees.length);renderEmployeeTable()}}catch(error){console.error('Load failed:',error)}}function renderEmployeeTable(){const tbody=document.getElementById('employeeTableBody');tbody.innerHTML='';let newHireCount=0,newHires1to30=0,newHires31to60=0,newHires61to90=0;const today=new Date();const thirtyDaysAgo=new Date(today.getTime()-30*24*60*60*1000);const sixtyDaysAgo=new Date(today.getTime()-60*24*60*60*1000);const ninetyDaysAgo=new Date(today.getTime()-90*24*60*60*1000);employees.forEach((emp,index)=>{const empDate=new Date(emp['Employment Date']);let rowColor='';if(empDate>ninetyDaysAgo&&empDate<=today){newHireCount++;if(empDate>thirtyDaysAgo){newHires1to30++;rowColor='background:#fee2e2;border-left:4px solid #ef4444;'}else if(empDate>sixtyDaysAgo){newHires31to60++;rowColor='background:#fef3c7;border-left:4px solid #f59e0b;'}else{newHires61to90++;rowColor='background:#dcfce7;border-left:4px solid #22c55e;'}}const row=document.createElement('tr');row.style.cssText=rowColor;row.innerHTML=`<td><input type="checkbox" class="employee-select" data-index="${index}"></td><td>${emp['First Name']||''}</td><td>${emp['Last Name']||''}</td><td>${emp.Department||''}</td><td>${emp.Position||''}</td><td>${emp['Employment Date']||''}</td><td>${emp['Years of Service']||''}</td><td>${emp.Email||''}</td><td>${emp.Phone||''}</td><td>${emp['Merch Requested']||''}</td><td>${emp['Merch Sent']||'No'}</td><td class="actions-col"><button class="btn btn-edit" onclick="openEditModal(${index})" title="Edit Employee">✏️</button><button class="btn btn-terminate" onclick="terminateEmployee(${index})" title="Terminate Employee">❌</button></td>`;tbody.appendChild(row)});document.getElementById('totalEmployees').textContent=employees.length;document.getElementById('newHires').textContent=newHireCount;const card1=document.getElementById('newHires1to30');card1.textContent=newHires1to30;card1.parentElement.style.borderLeft='4px solid #ef4444';card1.parentElement.onclick=()=>filterByRange('1-30');const card2=document.getElementById('newHires31to60');card2.textContent=newHires31to60;card2.parentElement.style.borderLeft='4px solid #f59e0b';card2.parentElement.onclick=()=>filterByRange('31-60');const card3=document.getElementById('newHires61to90');card3.textContent=newHires61to90;card3.parentElement.style.borderLeft='4px solid #22c55e';card3.parentElement.onclick=()=>filterByRange('61-90');document.getElementById('totalEmployees').parentElement.onclick=()=>filterByRange('all');document.getElementById('newHires').parentElement.onclick=()=>filterByRange('new')}function showTab(tabName){document.querySelectorAll('.tab-content').forEach(tab=>tab.classList.remove('active'));document.querySelectorAll('.nav-tab').forEach(tab=>tab.classList.remove('active'));document.getElementById(tabName).classList.add('active');document.querySelector(`[data-tab="${tabName}"]`).classList.add('active')}function generateEmployeeId(firstName,lastName){const first=(firstName||'').substring(0,2).toUpperCase();const last=(lastName||'').substring(0,2).toUpperCase();const timestamp=Date.now().toString().slice(-4);return`${first}${last}${timestamp}`}let currentEditIndex=-1;function openEditModal(index){currentEditIndex=index;const emp=employees[index];document.getElementById('editFirstName').value=emp['First Name']||'';document.getElementById('editLastName').value=emp['Last Name']||'';document.getElementById('editDepartment').value=emp.Department||'';document.getElementById('editPosition').value=emp.Position||'';document.getElementById('editEmploymentDate').value=emp['Employment Date']||'';document.getElementById('editYearsOfService').value=emp['Years of Service']||'';document.getElementById('editEmail').value=emp.Email||'';document.getElementById('editPhone').value=emp.Phone||'';document.getElementById('editMerchRequested').value=emp['Merch Requested']||'';document.getElementById('editMerchSent').value=emp['Merch Sent']||'No';document.getElementById('editMerchSentDate').value=emp['Merch Sent Date']||'';calculateYearsOfService();document.getElementById('editModal').style.display='block'}function closeEditModal(){document.getElementById('editModal').style.display='none';currentEditIndex=-1}function calculateYearsOfService(){const empDate=document.getElementById('editEmploymentDate').value;if(!empDate)return;const today=new Date();const employmentDate=new Date(empDate);const diffTime=Math.abs(today-employmentDate);const diffYears=(diffTime/(1000*60*60*24*365.25)).toFixed(1);document.getElementById('editYearsOfService').value=diffYears}async function saveEmployee(){if(currentEditIndex===-1)return;const emp=employees[currentEditIndex];emp['First Name']=document.getElementById('editFirstName').value;emp['Last Name']=document.getElementById('editLastName').value;emp.Department=document.getElementById('editDepartment').value;emp.Position=document.getElementById('editPosition').value;emp['Employment Date']=document.getElementById('editEmploymentDate').value;emp['Years of Service']=document.getElementById('editYearsOfService').value;emp.Email=document.getElementById('editEmail').value;emp.Phone=document.getElementById('editPhone').value;emp['Merch Requested']=document.getElementById('editMerchRequested').value;emp['Merch Sent']=document.getElementById('editMerchSent').value;emp['Merch Sent Date']=document.getElementById('editMerchSentDate').value;try{await saveEmployeesToDB([...employees,...terminatedEmployees]);renderEmployeeTable();closeEditModal()}catch(error){console.error('Save failed:',error)}}async function terminateEmployee(index){if(!confirm('Are you sure you want to terminate this employee?'))return;const employee=employees[index];const today=new Date().toISOString().split('T')[0];employee['Termination Date']=today;employee['Terminated']='Yes';terminatedEmployees.push(employee);employees.splice(index,1);try{await saveEmployeesToDB([...employees,...terminatedEmployees]);renderEmployeeTable()}catch(error){console.error('Terminate failed:',error)}}async function saveEmployeesToDB(allEmployees){try{const response=await fetch(`${API_BASE}/employees`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({employees:allEmployees})});if(!response.ok)throw new Error('Save failed');return await response.json()}catch(error){console.error('Database save failed:',error);throw error}}let currentFilter='all';function filterByRange(range){currentFilter=range;document.querySelectorAll('.stat-card').forEach(card=>card.classList.remove('active'));const today=new Date();const thirtyDaysAgo=new Date(today.getTime()-30*24*60*60*1000);const sixtyDaysAgo=new Date(today.getTime()-60*24*60*60*1000);const ninetyDaysAgo=new Date(today.getTime()-90*24*60*60*1000);const rows=document.querySelectorAll('#employeeTableBody tr');rows.forEach((row,index)=>{const emp=employees[index];if(!emp)return;const empDate=new Date(emp['Employment Date']);let show=false;switch(range){case'all':show=true;document.getElementById('totalEmployees').parentElement.classList.add('active');break;case'new':show=empDate>ninetyDaysAgo&&empDate<=today;document.getElementById('newHires').parentElement.classList.add('active');break;case'1-30':show=empDate>thirtyDaysAgo&&empDate<=today;document.getElementById('newHires1to30').parentElement.classList.add('active');break;case'31-60':show=empDate>sixtyDaysAgo&&empDate<=thirtyDaysAgo;document.getElementById('newHires31to60').parentElement.classList.add('active');break;case'61-90':show=empDate>ninetyDaysAgo&&empDate<=sixtyDaysAgo;document.getElementById('newHires61to90').parentElement.classList.add('active');break}row.style.display=show?'':'none'})}let sortDirection={};function sortTable(columnIndex){const tbody=document.getElementById('employeeTableBody');const rows=Array.from(tbody.rows);const direction=sortDirection[columnIndex]||'asc';sortDirection[columnIndex]=direction==='asc'?'desc':'asc';const actualColumnIndex=columnIndex+1;rows.sort((a,b)=>{let aVal=a.cells[actualColumnIndex].textContent.trim();let bVal=b.cells[actualColumnIndex].textContent.trim();if(columnIndex===4||columnIndex===5){aVal=new Date(aVal);bVal=new Date(bVal)}else if(columnIndex===5){aVal=parseFloat(aVal)||0;bVal=parseFloat(bVal)||0}if(aVal<bVal)return direction==='asc'?-1:1;if(aVal>bVal)return direction==='asc'?1:-1;return 0});rows.forEach(row=>tbody.appendChild(row))}function toggleSelectAllEmployees(){const selectAll=document.getElementById('selectAllEmployees');const checkboxes=document.querySelectorAll('.employee-select');checkboxes.forEach(cb=>cb.checked=selectAll.checked)}function searchEmployees(){const term=document.getElementById('globalSearch').value.toLowerCase();const rows=document.querySelectorAll('#employeeTableBody tr');rows.forEach(row=>{const text=row.textContent.toLowerCase();row.style.display=text.includes(term)?'':'none'})}document.addEventListener('DOMContentLoaded',function(){document.querySelectorAll('.nav-tab').forEach(tab=>{tab.addEventListener('click',()=>showTab(tab.dataset.tab))});document.getElementById('globalSearch').addEventListener('keypress',function(e){if(e.key==='Enter')searchEmployees()});document.getElementById('globalSearch').addEventListener('input',searchEmployees);loadEmployees();showTab('employees')});