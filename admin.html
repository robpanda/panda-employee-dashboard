<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Console - Panda Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #fafbfc;
            min-height: 100vh;
            color: #374151;
            font-weight: 400;
        }
        .main-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            overflow: hidden;
            max-width: 1400px;
            margin: 20px auto;
            border: 1px solid #f3f4f6;
        }
        .utility-nav {
            background: white;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 24px;
            border-bottom: 1px solid #f3f4f6;
        }
        .nav-links {
            display: flex;
            gap: 4px;
            flex: 1;
        }
        .nav-link {
            color: #6b7280;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.15s ease;
            font-weight: 400;
            font-size: 14px;
        }
        .nav-link:hover {
            background: #f9fafb;
            color: #374151;
            text-decoration: none;
        }
        .nav-link.active {
            background: #3b82f6;
            color: white;
            text-decoration: none;
            font-weight: 500;
        }
        .logout-btn {
            background: #f3f4f6;
            color: #6b7280;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 400;
            transition: all 0.15s ease;
        }
        .logout-btn:hover { 
            background: #ef4444;
            color: white;
        }
        .header {
            background: linear-gradient(135deg, #f8fafc 0%, #e5e7eb 100%);
            color: #374151;
            padding: 32px 40px;
            border-bottom: 1px solid #f3f4f6;
        }
        .logo img { height: 40px; }
        .header h1 { 
            margin: 16px 0 8px 0; 
            font-size: 28px; 
            font-weight: 600;
            color: #111827;
        }
        .header p { 
            color: #6b7280;
            margin-bottom: 0;
            font-size: 16px;
            font-weight: 400;
        }
        .content-area {
            padding: 32px 40px;
            background: white;
        }
        .card {
            border: 1px solid #f3f4f6;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
            border-radius: 12px;
            transition: all 0.15s ease;
            background: white;
        }
        .card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-color: #e5e7eb;
        }
        .card-header {
            background: #fafbfc;
            border-bottom: 1px solid #f3f4f6;
            font-weight: 500;
            color: #374151;
        }
        .btn {
            font-weight: 400;
            border-radius: 8px;
            transition: all 0.15s ease;
        }
        .btn-primary {
            background: #3b82f6;
            border-color: #3b82f6;
        }
        .btn-primary:hover {
            background: #2563eb;
            border-color: #2563eb;
        }
        .form-control, .form-select {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            transition: all 0.15s ease;
        }
        .form-control:focus, .form-select:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .table {
            font-size: 14px;
        }
        .table th {
            background: #fafbfc;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 500;
            color: #374151;
        }
        .table td {
            border-bottom: 1px solid #f3f4f6;
        }
        .badge {
            font-weight: 400;
            font-size: 12px;
        }
        .modal-content {
            border-radius: 12px;
            border: 1px solid #f3f4f6;
        }
        .modal-header {
            background: #fafbfc;
            border-bottom: 1px solid #f3f4f6;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="utility-nav">
            <div class="logo">
                <img src="panda-logo.png" alt="Panda Exteriors">
            </div>
            <div class="nav-links">
                <a href="/employee" class="nav-link">üë• Employees</a>
                <a href="/points" class="nav-link">‚≠ê Points</a>
                <a href="/leads" class="nav-link">üìä Leads</a>
                <a href="/referrals" class="nav-link">ü§ù Referrals</a>
                <a href="/assets" class="nav-link">üì¶ Assets</a>
                <a href="/admin" class="nav-link active">‚öôÔ∏è Admin</a>
            </div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
        
        <div class="header">
            <h1>üè¢ Employee & Admin CRM</h1>
            <p>Comprehensive employee database management, department assignments, and admin user control</p>
        </div>
        
        <div class="content-area">
            <!-- Quick Stats -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="text-primary" id="totalEmployees">0</h3>
                            <p class="mb-0">Total Employees</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="text-success" id="activeEmployees">0</h3>
                            <p class="mb-0">Active Employees</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="text-warning" id="totalDepartments">0</h3>
                            <p class="mb-0">Departments</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="text-info" id="totalAdmins">0</h3>
                            <p class="mb-0">Admin Users</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Tabs -->
            <ul class="nav nav-pills nav-fill mb-4" id="crmTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="employees-tab" data-bs-toggle="tab" data-bs-target="#employees" type="button" role="tab">
                        <i class="fas fa-users me-2"></i>Employee Management
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="departments-tab" data-bs-toggle="tab" data-bs-target="#departments" type="button" role="tab">
                        <i class="fas fa-building me-2"></i>Departments & Managers
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="admins-tab" data-bs-toggle="tab" data-bs-target="#admins" type="button" role="tab">
                        <i class="fas fa-user-shield me-2"></i>Admin Users
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="bulk-tab" data-bs-toggle="tab" data-bs-target="#bulk" type="button" role="tab">
                        <i class="fas fa-upload me-2"></i>Bulk Operations
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="crmTabContent">
                <!-- Employee Management Tab -->
                <div class="tab-pane fade show active" id="employees" role="tabpanel">
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5><i class="fas fa-user-plus"></i> Create New Employee</h5>
                            <button class="btn btn-outline-secondary btn-sm" onclick="toggleEmployeeForm()">
                                <i class="fas fa-plus"></i> Quick Add
                            </button>
                        </div>
                        <div class="card-body" id="employeeFormCard" style="display: none;">
                            <form id="newEmployeeForm">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label class="form-label">First Name *</label>
                                        <input type="text" class="form-control" id="empFirstName" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Last Name *</label>
                                        <input type="text" class="form-control" id="empLastName" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Employee ID *</label>
                                        <input type="text" class="form-control" id="empId" required>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Email *</label>
                                        <input type="email" class="form-control" id="empEmail" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Phone</label>
                                        <input type="tel" class="form-control" id="empPhone">
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Department *</label>
                                        <select class="form-select" id="empDepartment" required>
                                            <option value="">Select Department</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Manager</label>
                                        <select class="form-select" id="empManager">
                                            <option value="">Select Manager</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Office Location</label>
                                        <select class="form-select" id="empOffice">
                                            <option value="">Select Office</option>
                                            <option value="Maryland">Maryland</option>
                                            <option value="Virginia">Virginia</option>
                                            <option value="Pennsylvania">Pennsylvania</option>
                                            <option value="New Jersey">New Jersey</option>
                                            <option value="Delaware">Delaware</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Job Title</label>
                                        <input type="text" class="form-control" id="empTitle">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Hire Date</label>
                                        <input type="date" class="form-control" id="empHireDate">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Status</label>
                                        <select class="form-select" id="empStatus">
                                            <option value="active">Active</option>
                                            <option value="inactive">Inactive</option>
                                            <option value="terminated">Terminated</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <button type="button" class="btn btn-primary" onclick="createEmployee()">
                                        <i class="fas fa-save"></i> Create Employee
                                    </button>
                                    <button type="button" class="btn btn-secondary ms-2" onclick="resetEmployeeForm()">
                                        <i class="fas fa-undo"></i> Reset
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Employee Search & Filter -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <input type="text" class="form-control" id="employeeSearch" placeholder="Search by name, email, or ID..." onkeyup="filterEmployees()">
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select" id="departmentFilter" onchange="filterEmployees()">
                                        <option value="">All Departments</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select" id="statusFilter" onchange="filterEmployees()">
                                        <option value="">All Status</option>
                                        <option value="active">Active</option>
                                        <option value="inactive">Inactive</option>
                                        <option value="terminated">Terminated</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select" id="officeFilter" onchange="filterEmployees()">
                                        <option value="">All Offices</option>
                                        <option value="Maryland">Maryland</option>
                                        <option value="Virginia">Virginia</option>
                                        <option value="Pennsylvania">Pennsylvania</option>
                                        <option value="New Jersey">New Jersey</option>
                                        <option value="Delaware">Delaware</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-outline-primary w-100" onclick="refreshEmployees()">
                                        <i class="fas fa-sync"></i> Refresh
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Employee List -->
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-users"></i> Employee Database</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th>Employee</th>
                                            <th>ID</th>
                                            <th>Department</th>
                                            <th>Manager</th>
                                            <th>Office</th>
                                            <th>Status</th>
                                            <th>Points Balance</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="employeesTable">
                                        <tr>
                                            <td colspan="8" class="text-center py-4">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Departments & Managers Tab -->
                <div class="tab-pane fade" id="departments" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5><i class="fas fa-building"></i> Departments</h5>
                                    <button class="btn btn-primary btn-sm" onclick="showAddDepartment()">
                                        <i class="fas fa-plus"></i> Add Department
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div id="departmentsList"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-user-tie"></i> Manager Assignments</h5>
                                </div>
                                <div class="card-body">
                                    <div id="managersList"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5><i class="fas fa-star"></i> Manager Points Budget</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Manager</th>
                                            <th>Department</th>
                                            <th>Team Size</th>
                                            <th>Quarterly Budget</th>
                                            <th>Allocated</th>
                                            <th>Remaining</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="managersTable">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Admin Users Tab -->
                <div class="tab-pane fade" id="admins" role="tabpanel">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5><i class="fas fa-user-shield"></i> Admin User Management</h5>
                            <button class="btn btn-primary btn-sm" onclick="showAddUserModal()">
                                <i class="fas fa-plus"></i> Add Admin User
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Email</th>
                                            <th>Role</th>
                                            <th>Status</th>
                                            <th>Created</th>
                                            <th>Last Login</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="adminUsersTable">
                                        <tr>
                                            <td colspan="6" class="text-center">Loading admin users...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bulk Operations Tab -->
                <div class="tab-pane fade" id="bulk" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-upload"></i> Bulk Employee Import</h5>
                                </div>
                                <div class="card-body">
                                    <button class="btn btn-primary w-100 mb-3" onclick="window.open('/import-employees.html', '_blank')">
                                        <i class="fas fa-file-csv"></i> Import Active Headcount CSV
                                    </button>
                                    <input type="file" class="form-control mb-3" id="bulkEmployeeFile" accept=".csv,.xlsx">
                                    <button class="btn btn-outline-primary w-100" onclick="bulkImportEmployees()">
                                        <i class="fas fa-upload"></i> Import Custom CSV
                                    </button>
                                    <small class="text-muted mt-2 d-block">Use Active Headcount CSV for official updates, or upload custom format</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-download"></i> Export Data</h5>
                                </div>
                                <div class="card-body">
                                    <button class="btn btn-outline-primary w-100 mb-2" onclick="exportEmployees()">
                                        <i class="fas fa-users"></i> Export All Employees
                                    </button>
                                    <button class="btn btn-outline-success w-100 mb-2" onclick="exportDepartments()">
                                        <i class="fas fa-building"></i> Export Departments
                                    </button>
                                    <button class="btn btn-outline-info w-100" onclick="exportPointsReport()">
                                        <i class="fas fa-star"></i> Export Points Report
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5><i class="fas fa-tools"></i> Bulk Actions</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <button class="btn btn-warning w-100" onclick="bulkUpdateDepartments()">
                                        <i class="fas fa-edit"></i> Bulk Update Departments
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-info w-100" onclick="bulkAssignManagers()">
                                        <i class="fas fa-user-tie"></i> Bulk Assign Managers
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-success w-100" onclick="bulkAwardPoints()">
                                        <i class="fas fa-star"></i> Bulk Award Points
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Add User Modal -->
        <div class="modal fade" id="addUserModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add Admin User</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addUserForm">
                            <div class="mb-3">
                                <label for="userEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="userEmail" required>
                            </div>
                            <div class="mb-3">
                                <label for="userPassword" class="form-label">Password</label>
                                <input type="password" class="form-control" id="userPassword" required>
                            </div>
                            <div class="mb-3">
                                <label for="userRole" class="form-label">Role</label>
                                <select class="form-select" id="userRole">
                                    <option value="admin">Admin</option>
                                    <option value="super_admin">Super Admin</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="addAdminUser()">Add User</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Employee Modal -->
        <div class="modal fade" id="editEmployeeModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Employee</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editEmployeeForm">
                            <input type="hidden" id="editEmpId">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">First Name</label>
                                    <input type="text" class="form-control" id="editFirstName">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Last Name</label>
                                    <input type="text" class="form-control" id="editLastName">
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" id="editEmail">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Employee ID</label>
                                    <input type="text" class="form-control" id="editEmployeeId">
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-4">
                                    <label class="form-label">Department</label>
                                    <select class="form-select" id="editDepartment"></select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Manager</label>
                                    <select class="form-select" id="editManager"></select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" id="editStatus">
                                        <option value="active">Active</option>
                                        <option value="inactive">Inactive</option>
                                        <option value="terminated">Terminated</option>
                                    </select>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="updateEmployee()">Update Employee</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Suppress webpack dev server console logs
        if (typeof console !== 'undefined') {
            const originalLog = console.log;
            const originalError = console.error;
            console.log = function(...args) {
                if (args[0] && typeof args[0] === 'string' && 
                    (args[0].includes('[webpack-dev-server]') || args[0].includes('[HMR]'))) {
                    return;
                }
                originalLog.apply(console, args);
            };
            console.error = function(...args) {
                if (args[0] && typeof args[0] === 'string' && 
                    (args[0].includes('WebSocket connection') || args[0].includes('webpack-dev-server'))) {
                    return;
                }
                originalError.apply(console, args);
            };
        }
    </script>
    <script>
        function logout() {
            sessionStorage.removeItem('pandaAdmin');
            sessionStorage.removeItem('adminUser');
            window.location.href = '/login.html';
        }
        
        const API_URL = 'https://4ytrdf6rpklojh5c52gxpf5iei0winqx.lambda-url.us-east-2.on.aws';
        let employees = [];
        let departments = ['Sales', 'Operations', 'Administration', 'Marketing', 'Finance', 'IT'];
        let managers = [];

        document.addEventListener('DOMContentLoaded', function() {
            loadEmployees();
            loadAdminUsers();
            loadDepartments();
            loadManagers();
            updateStats();
        });

        function toggleEmployeeForm() {
            const form = document.getElementById('employeeFormCard');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }

        async function loadEmployees() {
            try {
                const response = await fetch(`${API_URL}/employees`);
                const data = await response.json();
                employees = data.employees || data || [];
                displayEmployees();
                populateFilters();
                updateStats();
                loadDepartments();
                loadManagers();
            } catch (error) {
                console.error('Error loading employees:', error);
                displayEmployees([]);
            }
        }

        function displayEmployees() {
            const tbody = document.getElementById('employeesTable');
            if (!employees.length) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">No employees found</td></tr>';
                return;
            }

            tbody.innerHTML = employees.map(emp => {
                const name = emp['First Name'] && emp['Last Name'] ? 
                    `${emp['First Name']} ${emp['Last Name']}` : 
                    (emp.name || `${emp.first_name || ''} ${emp.last_name || ''}`);
                const email = emp['Email'] || emp.email || '-';
                const empId = emp.employee_id || emp.id || '-';
                const department = emp['Department'] || emp.department || '-';
                const manager = emp.manager || emp.supervisor || '-';
                const office = emp.office || '-';
                const terminated = emp['Terminated'] || emp.terminated || 'No';
                const status = terminated === 'Yes' ? 'terminated' : 'active';
                
                return `
                    <tr>
                        <td>
                            <div>
                                <strong>${name}</strong>
                                <br><small class="text-muted">${email}</small>
                            </div>
                        </td>
                        <td>${empId}</td>
                        <td>${department}</td>
                        <td>${manager}</td>
                        <td>${office}</td>
                        <td><span class="badge bg-${status === 'active' ? 'success' : 'danger'}">${status}</span></td>
                        <td><span class="badge bg-warning text-dark">0 pts</span></td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editEmployee('${empId}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-success" onclick="awardPoints('${empId}')">
                                    <i class="fas fa-star"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function populateFilters() {
            const deptFilter = document.getElementById('departmentFilter');
            const empDept = document.getElementById('empDepartment');
            
            const uniqueDepts = [...new Set(employees.map(e => e['Department'] || e.department).filter(Boolean))];
            
            [deptFilter, empDept].forEach(select => {
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = select.id === 'departmentFilter' ? '<option value="">All Departments</option>' : '<option value="">Select Department</option>';
                    uniqueDepts.forEach(dept => {
                        select.innerHTML += `<option value="${dept}">${dept}</option>`;
                    });
                    departments.forEach(dept => {
                        if (!uniqueDepts.includes(dept)) {
                            select.innerHTML += `<option value="${dept}">${dept}</option>`;
                        }
                    });
                    select.value = currentValue;
                }
            });
            
            // Populate manager dropdown
            const empManager = document.getElementById('empManager');
            const editManager = document.getElementById('editManager');
            const uniqueManagers = [...new Set(employees.map(e => {
                const name = e['First Name'] && e['Last Name'] ? 
                    `${e['First Name']} ${e['Last Name']}` : 
                    (e.name || `${e.first_name || ''} ${e.last_name || ''}`);
                return name;
            }).filter(Boolean))];
            
            [empManager, editManager].forEach(select => {
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Select Manager</option>';
                    uniqueManagers.forEach(manager => {
                        select.innerHTML += `<option value="${manager}">${manager}</option>`;
                    });
                    select.value = currentValue;
                }
            });
        }

        function filterEmployees() {
            const search = document.getElementById('employeeSearch').value.toLowerCase();
            const dept = document.getElementById('departmentFilter').value;
            const status = document.getElementById('statusFilter').value;
            const office = document.getElementById('officeFilter').value;

            const filteredEmployees = employees.filter(emp => {
                const name = (emp['First Name'] && emp['Last Name'] ? 
                    `${emp['First Name']} ${emp['Last Name']}` : 
                    (emp.name || `${emp.first_name || ''} ${emp.last_name || ''}`)).toLowerCase();
                const email = (emp['Email'] || emp.email || '').toLowerCase();
                const empId = (emp.employee_id || emp.id || '').toLowerCase();
                const department = emp['Department'] || emp.department || '';
                const empOffice = emp.office || '';
                const terminated = emp['Terminated'] || emp.terminated || 'No';
                const empStatus = terminated === 'Yes' ? 'terminated' : 'active';

                const matchesSearch = !search || name.includes(search) || email.includes(search) || empId.includes(search);
                const matchesDept = !dept || department === dept;
                const matchesStatus = !status || empStatus === status;
                const matchesOffice = !office || empOffice === office;

                return matchesSearch && matchesDept && matchesStatus && matchesOffice;
            });

            // Temporarily store original employees and display filtered
            const originalEmployees = employees;
            employees = filteredEmployees;
            displayEmployees();
            employees = originalEmployees;
        }

        async function createEmployee() {
            const form = document.getElementById('newEmployeeForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const employee = {
                first_name: document.getElementById('empFirstName').value,
                last_name: document.getElementById('empLastName').value,
                email: document.getElementById('empEmail').value,
                phone: document.getElementById('empPhone').value,
                department: document.getElementById('empDepartment').value,
                manager: document.getElementById('empManager').value,
                office: document.getElementById('empOffice').value,
                position: document.getElementById('empTitle').value,
                employment_date: document.getElementById('empHireDate').value || new Date().toISOString().split('T')[0],
                terminated: document.getElementById('empStatus').value === 'terminated' ? 'Yes' : 'No'
            };

            try {
                const response = await fetch(`${API_URL}/employees`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(employee)
                });

                if (response.ok) {
                    alert('Employee created successfully!');
                    resetEmployeeForm();
                    loadEmployees();
                } else {
                    throw new Error('Failed to create employee');
                }
            } catch (error) {
                alert('Error creating employee: ' + error.message);
            }
        }

        function resetEmployeeForm() {
            document.getElementById('newEmployeeForm').reset();
            document.getElementById('employeeFormCard').style.display = 'none';
        }

        function refreshEmployees() {
            loadEmployees();
        }

        function updateStats() {
            const total = employees.length;
            const active = employees.filter(e => {
                const terminated = e['Terminated'] || e.terminated || 'No';
                return terminated === 'No';
            }).length;
            const depts = new Set(employees.map(e => e['Department'] || e.department).filter(Boolean)).size;
            
            document.getElementById('totalEmployees').textContent = total;
            document.getElementById('activeEmployees').textContent = active;
            document.getElementById('totalDepartments').textContent = depts;
            
            // Load admin users count
            fetch(`${API_URL}/admin-users`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('totalAdmins').textContent = data.users ? data.users.length : 0;
                })
                .catch(() => {
                    document.getElementById('totalAdmins').textContent = '0';
                });
        }
        
        async function loadAdminUsers() {
            try {
                const response = await fetch(`${API_URL}/admin-users`);
                const data = await response.json();
                
                const tbody = document.getElementById('adminUsersTable');
                if (data.users && data.users.length > 0) {
                    tbody.innerHTML = data.users.map(user => `
                        <tr>
                            <td>
                                <div>
                                    <strong>${user.name || user.email}</strong>
                                    <br><small class="text-muted">${user.email}</small>
                                </div>
                            </td>
                            <td><span class="badge bg-primary">${user.role}</span></td>
                            <td><span class="badge ${user.active ? 'bg-success' : 'bg-secondary'}">${user.active ? 'Active' : 'Inactive'}</span></td>
                            <td>${user.created_at ? new Date(user.created_at).toLocaleDateString() : 'N/A'}</td>
                            <td>N/A</td>
                            <td>
                                <button class="btn btn-sm btn-outline-info" onclick="viewAdminDetails('${user.email}')">
                                    <i class="fas fa-eye"></i> View
                                </button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center">No admin users found</td></tr>';
                }
            } catch (error) {
                document.getElementById('adminUsersTable').innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading admin users</td></tr>';
            }
        }
        
        function showAddUserModal() {
            new bootstrap.Modal(document.getElementById('addUserModal')).show();
        }
        
        async function addAdminUser() {
            const email = document.getElementById('userEmail').value;
            const password = document.getElementById('userPassword').value;
            const role = document.getElementById('userRole').value;
            
            if (!email || !password) {
                alert('Please fill in all fields');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/admin-users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, role })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Admin user created successfully');
                    bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
                    document.getElementById('addUserForm').reset();
                    loadAdminUsers();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                alert('Error creating admin user');
            }
        }

        function loadDepartments() {
            const container = document.getElementById('departmentsList');
            const actualDepts = [...new Set(employees.map(e => e['Department'] || e.department).filter(Boolean))];
            const deptCounts = {};
            
            employees.forEach(emp => {
                const dept = emp['Department'] || emp.department;
                if (dept) {
                    deptCounts[dept] = (deptCounts[dept] || 0) + 1;
                }
            });
            
            container.innerHTML = actualDepts.map(dept => `
                <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                    <div>
                        <strong>${dept}</strong>
                        <br><small class="text-muted">${deptCounts[dept]} employees</small>
                    </div>
                    <button class="btn btn-sm btn-outline-primary" onclick="viewDepartmentEmployees('${dept}')">
                        <i class="fas fa-users"></i> View
                    </button>
                </div>
            `).join('');
        }

        function loadManagers() {
            const uniqueSupervisors = [...new Set(employees.map(e => e.supervisor).filter(Boolean))];
            
            const container = document.getElementById('managersList');
            container.innerHTML = uniqueSupervisors.map(supervisor => {
                const teamMembers = employees.filter(e => e.supervisor === supervisor);
                const teamSize = teamMembers.length;
                return `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                        <div>
                            <strong>${supervisor}</strong>
                            <br><small class="text-muted">Team: ${teamSize} employees</small>
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewManagerTeam('${supervisor}')">
                            <i class="fas fa-users"></i> View Team
                        </button>
                    </div>
                `;
            }).join('');

            // Update managers table
            const tbody = document.getElementById('managersTable');
            tbody.innerHTML = uniqueSupervisors.map(supervisor => {
                const teamMembers = employees.filter(e => e.supervisor === supervisor);
                const teamSize = teamMembers.length;
                const budget = teamSize * 100;
                const departments = [...new Set(teamMembers.map(e => e['Department'] || e.department).filter(Boolean))];
                return `
                    <tr>
                        <td>${supervisor}</td>
                        <td>${departments.join(', ') || 'Multiple'}</td>
                        <td>${teamSize}</td>
                        <td>$${budget}</td>
                        <td>$0</td>
                        <td>$${budget}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="adjustBudget('${supervisor}')">
                                <i class="fas fa-edit"></i> Adjust
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function showAddDepartment() {
            const name = prompt('Enter department name:');
            if (name && !departments.includes(name)) {
                departments.push(name);
                loadDepartments();
                populateFilters();
            }
        }

        function editDepartment(dept) {
            const newName = prompt('Edit department name:', dept);
            if (newName && newName !== dept) {
                const index = departments.indexOf(dept);
                if (index > -1) departments[index] = newName;
                loadDepartments();
                populateFilters();
            }
        }

        function deleteDepartment(dept) {
            if (confirm(`Delete department "${dept}"?`)) {
                departments = departments.filter(d => d !== dept);
                loadDepartments();
                populateFilters();
            }
        }

        function viewManagerTeam(supervisor) {
            const team = employees.filter(e => e.supervisor === supervisor);
            const teamList = team.map(e => {
                const name = e['First Name'] && e['Last Name'] ? `${e['First Name']} ${e['Last Name']}` : e.name;
                const dept = e['Department'] || e.department || 'Unknown';
                return `‚Ä¢ ${name} (${dept})`;
            }).join('\n');
            alert(`${supervisor}'s Team (${team.length} employees):\n\n${teamList}`);
        }

        function viewDepartmentEmployees(department) {
            const deptEmployees = employees.filter(e => (e['Department'] || e.department) === department);
            const empList = deptEmployees.map(e => {
                const name = e['First Name'] && e['Last Name'] ? `${e['First Name']} ${e['Last Name']}` : e.name;
                const supervisor = e.supervisor || 'No supervisor';
                return `‚Ä¢ ${name} (${supervisor})`;
            }).join('\n');
            alert(`${department} Department (${deptEmployees.length} employees):\n\n${empList}`);
        }

        function adjustBudget(manager) {
            alert(`Budget adjustment for ${manager} - Feature coming soon!`);
        }

        // Bulk operations
        function bulkImportEmployees() {
            alert('Bulk import feature - Integration with file upload system');
        }

        function exportEmployees() {
            const csv = 'Name,Email,EmployeeID,Department,Manager,Office,Status\n' +
                employees.map(e => `${e.name},${e.email},${e.employee_id},${e.department},${e.manager},${e.office},${e.status}`).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'employees.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportDepartments() {
            alert('Export departments feature - Coming soon!');
        }

        function exportPointsReport() {
            alert('Export points report feature - Coming soon!');
        }

        function bulkUpdateDepartments() {
            alert('Bulk update departments feature - Coming soon!');
        }

        function bulkAssignManagers() {
            alert('Bulk assign managers feature - Coming soon!');
        }

        function bulkAwardPoints() {
            alert('Bulk award points feature - Coming soon!');
        }

        async function editEmployee(empId) {
            const employee = employees.find(e => (e.employee_id || e.id) === empId);
            if (!employee) {
                alert('Employee not found');
                return;
            }

            // Populate edit form
            document.getElementById('editEmpId').value = empId;
            document.getElementById('editFirstName').value = employee['First Name'] || employee.first_name || '';
            document.getElementById('editLastName').value = employee['Last Name'] || employee.last_name || '';
            document.getElementById('editEmail').value = employee['Email'] || employee.email || '';
            document.getElementById('editEmployeeId').value = empId;
            
            // Populate department dropdown for edit form
            const editDept = document.getElementById('editDepartment');
            editDept.innerHTML = '<option value="">Select Department</option>';
            const uniqueDepts = [...new Set(employees.map(e => e['Department'] || e.department).filter(Boolean))];
            [...uniqueDepts, ...departments].forEach(dept => {
                if (dept) editDept.innerHTML += `<option value="${dept}">${dept}</option>`;
            });
            editDept.value = employee['Department'] || employee.department || '';
            
            const terminated = employee['Terminated'] || employee.terminated || 'No';
            document.getElementById('editStatus').value = terminated === 'Yes' ? 'terminated' : 'active';

            new bootstrap.Modal(document.getElementById('editEmployeeModal')).show();
        }

        async function updateEmployee() {
            const empId = document.getElementById('editEmpId').value;
            const updates = {
                'First Name': document.getElementById('editFirstName').value,
                'Last Name': document.getElementById('editLastName').value,
                'Email': document.getElementById('editEmail').value,
                'Department': document.getElementById('editDepartment').value,
                'Terminated': document.getElementById('editStatus').value === 'terminated' ? 'Yes' : 'No'
            };

            try {
                console.log('Updating employee:', empId, 'with data:', updates);
                const response = await fetch(`${API_URL}/employees/${empId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates)
                });

                const responseText = await response.text();
                console.log('Update response:', response.status, responseText);

                if (response.ok) {
                    alert('Employee updated successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('editEmployeeModal')).hide();
                    await loadEmployees();
                } else {
                    throw new Error(`Server error: ${responseText}`);
                }
            } catch (error) {
                console.error('Update error:', error);
                alert('Error updating employee: ' + error.message);
            }
        }

        async function awardPoints(empId) {
            const employee = employees.find(e => (e.employee_id || e.id) === empId);
            if (!employee) {
                alert('Employee not found');
                return;
            }

            const points = prompt(`Award points to ${employee['First Name']} ${employee['Last Name']}:`);
            if (points && !isNaN(points) && parseInt(points) > 0) {
                // This would integrate with the points system
                alert(`Awarded ${points} points to ${employee['First Name']} ${employee['Last Name']}`);
                // TODO: Implement actual points awarding via API
            }
        }

        function viewAdminDetails(email) {
            const admin = employees.find(e => (e.Email || e.email) === email);
            if (admin) {
                const name = admin['First Name'] && admin['Last Name'] ? 
                    `${admin['First Name']} ${admin['Last Name']}` : 'Unknown';
                const dept = admin['Department'] || admin.department || 'Unknown';
                const position = admin['Position'] || admin.position || 'Unknown';
                const hireDate = admin['Employment Date'] || admin.employment_date || 'Unknown';
                
                alert(`Admin Details:\n\nName: ${name}\nEmail: ${email}\nDepartment: ${dept}\nPosition: ${position}\nHire Date: ${hireDate}`);
            } else {
                alert('Admin details not found');
            }
        }
    </script>
</body>
</html>