<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Console - Panda Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #fafbfc;
            min-height: 100vh;
            color: #374151;
            font-weight: 400;
        }
        .main-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            overflow: hidden;
            max-width: 1400px;
            margin: 20px auto;
            border: 1px solid #f3f4f6;
        }
        .utility-nav {
            background: white;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 24px;
            border-bottom: 1px solid #f3f4f6;
        }
        .nav-links {
            display: flex;
            gap: 4px;
            flex: 1;
        }
        .nav-link {
            color: #6b7280;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.15s ease;
            font-weight: 400;
            font-size: 14px;
        }
        .nav-link:hover {
            background: #f9fafb;
            color: #374151;
            text-decoration: none;
        }
        .nav-link.active {
            background: #3b82f6;
            color: white;
            text-decoration: none;
            font-weight: 500;
        }
        .logout-btn {
            background: #f3f4f6;
            color: #6b7280;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 400;
            transition: all 0.15s ease;
        }
        .logout-btn:hover { 
            background: #ef4444;
            color: white;
        }
        .header {
            background: linear-gradient(135deg, #f8fafc 0%, #e5e7eb 100%);
            color: #374151;
            padding: 32px 40px;
            border-bottom: 1px solid #f3f4f6;
        }
        .logo img { height: 40px; }
        .header h1 { 
            margin: 16px 0 8px 0; 
            font-size: 28px; 
            font-weight: 600;
            color: #111827;
        }
        .header p { 
            color: #6b7280;
            margin-bottom: 0;
            font-size: 16px;
            font-weight: 400;
        }
        .content-area {
            padding: 32px 40px;
            background: white;
        }
        .card {
            border: 1px solid #f3f4f6;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
            border-radius: 12px;
            transition: all 0.15s ease;
            background: white;
        }
        .card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-color: #e5e7eb;
        }
        .card-header {
            background: #fafbfc;
            border-bottom: 1px solid #f3f4f6;
            font-weight: 500;
            color: #374151;
        }
        .btn {
            font-weight: 400;
            border-radius: 8px;
            transition: all 0.15s ease;
        }
        .btn-primary {
            background: #3b82f6;
            border-color: #3b82f6;
        }
        .btn-primary:hover {
            background: #2563eb;
            border-color: #2563eb;
        }
        .form-control, .form-select {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            transition: all 0.15s ease;
        }
        .form-control:focus, .form-select:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .table {
            font-size: 14px;
        }
        .table th {
            background: #fafbfc;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 500;
            color: #374151;
        }
        .table td {
            border-bottom: 1px solid #f3f4f6;
        }
        .badge {
            font-weight: 400;
            font-size: 12px;
        }
        .modal-content {
            border-radius: 12px;
            border: 1px solid #f3f4f6;
        }
        .modal-header {
            background: #fafbfc;
            border-bottom: 1px solid #f3f4f6;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="utility-nav">
            <div class="logo">
                <img src="panda-logo.png" alt="Panda Exteriors">
            </div>
            <div class="nav-links">
                <a href="/employee.html" class="nav-link">üë• Employees</a>
                <a href="/points.html" class="nav-link">‚≠ê Points</a>
                <a href="/leads.html" class="nav-link">üìä Leads</a>
                <a href="/referrals.html" class="nav-link">ü§ù Referrals</a>
                <a href="/assets.html" class="nav-link">üì¶ Assets</a>
                <a href="/admin.html" class="nav-link active">‚öôÔ∏è Admin</a>
            </div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
        
        <div class="header">
            <h1>üè¢ Employee & Admin CRM</h1>
            <p>Comprehensive employee database management, department assignments, and admin user control</p>
        </div>
        
        <div class="content-area">
            <!-- Quick Stats -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="text-primary" id="totalEmployees">0</h3>
                            <p class="mb-0">Total Employees</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="text-success" id="activeEmployees">0</h3>
                            <p class="mb-0">Active Employees</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="text-warning" id="totalDepartments">0</h3>
                            <p class="mb-0">Departments</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="text-info" id="totalAdmins">0</h3>
                            <p class="mb-0">Admin Users</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Tabs -->
            <ul class="nav nav-pills nav-fill mb-4" id="crmTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="employees-tab" data-bs-toggle="tab" data-bs-target="#employees" type="button" role="tab">
                        <i class="fas fa-users me-2"></i>Employee Management
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="departments-tab" data-bs-toggle="tab" data-bs-target="#departments" type="button" role="tab">
                        <i class="fas fa-building me-2"></i>Departments & Managers
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="admins-tab" data-bs-toggle="tab" data-bs-target="#admins" type="button" role="tab">
                        <i class="fas fa-user-shield me-2"></i>Admin Users
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="bulk-tab" data-bs-toggle="tab" data-bs-target="#bulk" type="button" role="tab">
                        <i class="fas fa-upload me-2"></i>Bulk Operations
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="crmTabContent">
                <!-- Employee Management Tab -->
                <div class="tab-pane fade show active" id="employees" role="tabpanel">
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5><i class="fas fa-user-plus"></i> Create New Employee</h5>
                            <button class="btn btn-outline-secondary btn-sm" onclick="toggleEmployeeForm()">
                                <i class="fas fa-plus"></i> Quick Add
                            </button>
                        </div>
                        <div class="card-body" id="employeeFormCard" style="display: none;">
                            <form id="newEmployeeForm">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label class="form-label">First Name *</label>
                                        <input type="text" class="form-control" id="empFirstName" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Last Name *</label>
                                        <input type="text" class="form-control" id="empLastName" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Employee ID *</label>
                                        <input type="text" class="form-control" id="empId" required>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Email *</label>
                                        <input type="email" class="form-control" id="empEmail" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Phone</label>
                                        <input type="tel" class="form-control" id="empPhone">
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Department *</label>
                                        <select class="form-select" id="empDepartment" required>
                                            <option value="">Select Department</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Manager</label>
                                        <select class="form-select" id="empManager">
                                            <option value="">Select Manager</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Office Location</label>
                                        <select class="form-select" id="empOffice">
                                            <option value="">Select Office</option>
                                            <option value="Maryland">Maryland</option>
                                            <option value="Virginia">Virginia</option>
                                            <option value="Pennsylvania">Pennsylvania</option>
                                            <option value="New Jersey">New Jersey</option>
                                            <option value="Delaware">Delaware</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Job Title</label>
                                        <input type="text" class="form-control" id="empTitle">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Hire Date</label>
                                        <input type="date" class="form-control" id="empHireDate">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Status</label>
                                        <select class="form-select" id="empStatus">
                                            <option value="active">Active</option>
                                            <option value="inactive">Inactive</option>
                                            <option value="terminated">Terminated</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <button type="button" class="btn btn-primary" onclick="createEmployee()">
                                        <i class="fas fa-save"></i> Create Employee
                                    </button>
                                    <button type="button" class="btn btn-secondary ms-2" onclick="resetEmployeeForm()">
                                        <i class="fas fa-undo"></i> Reset
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Employee Search & Filter -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <input type="text" class="form-control" id="employeeSearch" placeholder="Search by name, email, or ID..." onkeyup="filterEmployees()">
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select" id="departmentFilter" onchange="filterEmployees()">
                                        <option value="">All Departments</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select" id="statusFilter" onchange="filterEmployees()">
                                        <option value="">All Status</option>
                                        <option value="active">Active</option>
                                        <option value="inactive">Inactive</option>
                                        <option value="terminated">Terminated</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select" id="officeFilter" onchange="filterEmployees()">
                                        <option value="">All Offices</option>
                                        <option value="Maryland">Maryland</option>
                                        <option value="Virginia">Virginia</option>
                                        <option value="Pennsylvania">Pennsylvania</option>
                                        <option value="New Jersey">New Jersey</option>
                                        <option value="Delaware">Delaware</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-outline-primary w-100" onclick="refreshEmployees()">
                                        <i class="fas fa-sync"></i> Refresh
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Employee List -->
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-users"></i> Employee Database</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th style="cursor: pointer;" onclick="sortTable('name')">
                                                Employee <i class="fas fa-sort" id="sort-name"></i>
                                            </th>
                                            <th style="cursor: pointer;" onclick="sortTable('id')">
                                                ID <i class="fas fa-sort" id="sort-id"></i>
                                            </th>
                                            <th style="cursor: pointer;" onclick="sortTable('department')">
                                                Department <i class="fas fa-sort" id="sort-department"></i>
                                            </th>
                                            <th style="cursor: pointer;" onclick="sortTable('manager')">
                                                Manager <i class="fas fa-sort" id="sort-manager"></i>
                                            </th>
                                            <th style="cursor: pointer;" onclick="sortTable('office')">
                                                Office <i class="fas fa-sort" id="sort-office"></i>
                                            </th>
                                            <th style="cursor: pointer;" onclick="sortTable('status')">
                                                Status <i class="fas fa-sort" id="sort-status"></i>
                                            </th>
                                            <th style="cursor: pointer;" onclick="sortTable('points')">
                                                Points Balance <i class="fas fa-sort" id="sort-points"></i>
                                            </th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="employeesTable">
                                        <tr>
                                            <td colspan="8" class="text-center py-4">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Departments & Managers Tab -->
                <div class="tab-pane fade" id="departments" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5><i class="fas fa-building"></i> Departments</h5>
                                    <button class="btn btn-primary btn-sm" onclick="showAddDepartment()">
                                        <i class="fas fa-plus"></i> Add Department
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div id="departmentsList"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5><i class="fas fa-user-tie"></i> Manager Assignments</h5>
                                    <button class="btn btn-primary btn-sm" onclick="showAddManager()">
                                        <i class="fas fa-plus"></i> Add Manager
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div id="managersList"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5><i class="fas fa-star"></i> Manager Points Budget</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Manager</th>
                                            <th>Department</th>
                                            <th>Team Size</th>
                                            <th>Quarterly Budget</th>
                                            <th>Allocated</th>
                                            <th>Remaining</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="managersTable">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Admin Users Tab -->
                <div class="tab-pane fade" id="admins" role="tabpanel">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5><i class="fas fa-user-shield"></i> Admin User Management</h5>
                            <button class="btn btn-primary btn-sm" onclick="showAddUserModal()">
                                <i class="fas fa-plus"></i> Add Admin User
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Email</th>
                                            <th>Role</th>
                                            <th>Status</th>
                                            <th>Created</th>
                                            <th>Last Login</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="adminUsersTable">
                                        <tr>
                                            <td colspan="6" class="text-center">Loading admin users...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bulk Operations Tab -->
                <div class="tab-pane fade" id="bulk" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-upload"></i> Bulk Employee Import</h5>
                                </div>
                                <div class="card-body">
                                    <button class="btn btn-primary w-100 mb-3" onclick="window.open('/import-employees.html', '_blank')">
                                        <i class="fas fa-file-csv"></i> Import Active Headcount CSV
                                    </button>
                                    <input type="file" class="form-control mb-3" id="bulkEmployeeFile" accept=".csv,.xlsx">
                                    <button class="btn btn-outline-primary w-100" onclick="bulkImportEmployees()">
                                        <i class="fas fa-upload"></i> Import Custom CSV
                                    </button>
                                    <small class="text-muted mt-2 d-block">Use Active Headcount CSV for official updates, or upload custom format</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-download"></i> Export Data</h5>
                                </div>
                                <div class="card-body">
                                    <button class="btn btn-outline-primary w-100 mb-2" onclick="exportEmployees()">
                                        <i class="fas fa-users"></i> Export All Employees
                                    </button>
                                    <button class="btn btn-outline-success w-100 mb-2" onclick="exportDepartments()">
                                        <i class="fas fa-building"></i> Export Departments
                                    </button>
                                    <button class="btn btn-outline-info w-100" onclick="exportPointsReport()">
                                        <i class="fas fa-star"></i> Export Points Report
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5><i class="fas fa-tools"></i> Bulk Actions</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <button class="btn btn-warning w-100" onclick="bulkUpdateDepartments()">
                                        <i class="fas fa-edit"></i> Bulk Update Departments
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-info w-100" onclick="bulkAssignManagers()">
                                        <i class="fas fa-user-tie"></i> Bulk Assign Managers
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-success w-100" onclick="bulkAwardPoints()">
                                        <i class="fas fa-star"></i> Bulk Award Points
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Add User Modal -->
        <div class="modal fade" id="addUserModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add Admin User</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addUserForm">
                            <div class="mb-3">
                                <label for="userEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="userEmail" required>
                            </div>
                            <div class="mb-3">
                                <label for="userPassword" class="form-label">Password</label>
                                <input type="password" class="form-control" id="userPassword" required>
                            </div>
                            <div class="mb-3">
                                <label for="userRole" class="form-label">Role</label>
                                <select class="form-select" id="userRole">
                                    <option value="admin">Full Admin</option>
                                    <option value="referrals_admin">Referrals Admin</option>
                                    <option value="points_admin">Points Admin</option>
                                    <option value="super_admin">Super Admin</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Permissions</label>
                                <div class="mt-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="permEmployees" value="employees">
                                        <label class="form-check-label" for="permEmployees">Employee Management</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="permPoints" value="points">
                                        <label class="form-check-label" for="permPoints">Points Management</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="permReferrals" value="referrals" checked>
                                        <label class="form-check-label" for="permReferrals">Referrals Management</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="permLeads" value="leads">
                                        <label class="form-check-label" for="permLeads">Leads Management</label>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="addAdminUser()">Add User</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Employee Modal -->
        <div class="modal fade" id="editEmployeeModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Employee</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Tabs -->
                        <ul class="nav nav-tabs mb-3" id="editEmployeeTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="employee-info-tab" data-bs-toggle="tab" data-bs-target="#employee-info" type="button" role="tab">Employee Info</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="login-history-tab" data-bs-toggle="tab" data-bs-target="#login-history" type="button" role="tab">Login History (60 days)</button>
                            </li>
                        </ul>
                        
                        <div class="tab-content" id="editEmployeeTabContent">
                            <div class="tab-pane fade show active" id="employee-info" role="tabpanel">
                                <form id="editEmployeeForm">
                                    <input type="hidden" id="editEmpId">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">First Name</label>
                                    <input type="text" class="form-control" id="editFirstName">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Last Name</label>
                                    <input type="text" class="form-control" id="editLastName">
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-4">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" id="editEmail" readonly>
                                    <small class="text-muted">Email cannot be changed</small>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Employee ID</label>
                                    <input type="text" class="form-control" id="editEmployeeId">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Password</label>
                                    <input type="password" class="form-control" id="editPassword" placeholder="Leave blank to keep current">
                                    <small class="text-muted">Leave blank to keep current password</small>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-4">
                                    <label class="form-label">Department</label>
                                    <select class="form-select" id="editDepartment"></select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Manager</label>
                                    <select class="form-select" id="editManager"></select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" id="editStatus">
                                        <option value="active">Active</option>
                                        <option value="inactive">Inactive</option>
                                        <option value="terminated">Terminated</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-3">
                                    <label class="form-label">Panda Points Balance</label>
                                    <input type="number" class="form-control" id="editPoints" min="0">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Is Supervisor</label>
                                    <select class="form-select" id="editIsSupervisor">
                                        <option value="No">No</option>
                                        <option value="Yes">Yes</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Points Manager</label>
                                    <select class="form-select" id="editPointsManager" onchange="toggleBudgetField()">
                                        <option value="No">No</option>
                                        <option value="Yes">Yes</option>
                                    </select>
                                    <small class="text-muted">Directors, VPs, Presidents, C-Suite</small>
                                </div>
                                <div class="col-md-3" id="budgetFieldContainer" style="display: none;">
                                    <label class="form-label">Quarterly Points Budget</label>
                                    <input type="number" class="form-control" id="editPointsBudget" value="500" min="0">
                                    <small class="text-muted">Points budget per quarter</small>
                                </div>
                            </div>
                        </form>
                            </div>
                            
                            <div class="tab-pane fade" id="login-history" role="tabpanel">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Time</th>
                                                <th>Status</th>
                                                <th>Notes</th>
                                            </tr>
                                        </thead>
                                        <tbody id="loginHistoryTable">
                                            <tr><td colspan="4" class="text-center">Loading...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" onclick="deleteEmployeeFromModal()">Delete Employee</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="updateEmployee()">Update Employee</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modern Modal -->
    <div class="modal fade" id="modernModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modernModalTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modernModalBody"></div>
                <div class="modal-footer" id="modernModalFooter">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="modernModalConfirm">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
        <div id="liveToast" class="toast" role="alert">
            <div class="toast-header">
                <i class="fas fa-info-circle text-primary me-2"></i>
                <strong class="me-auto">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastBody"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="auth-check.js"></script>
    <script>
        // Suppress webpack dev server console logs
        if (typeof console !== 'undefined') {
            const originalError = console.error;
            console.error = function(...args) {
                if (args[0] && typeof args[0] === 'string' && 
                    (args[0].includes('WebSocket connection') || args[0].includes('webpack-dev-server'))) {
                    return;
                }
                originalError.apply(console, args);
            };
        }
    </script>
    <script>
        function logout() {
            sessionStorage.removeItem('pandaAdmin');
            sessionStorage.removeItem('adminUser');
            window.location.href = '/login.html';
        }
        
        const API_URL = 'https://dfu3zr3dnrvgiiwa2yu77cz5fq0rqmth.lambda-url.us-east-2.on.aws';
        let employees = [];
        let departments = ['Sales', 'Operations', 'Administration', 'Marketing', 'Finance', 'IT'];
        let managers = [];
        let sortColumn = 'name';
        let sortDirection = 'asc';

        document.addEventListener('DOMContentLoaded', function() {
            loadEmployees();
            loadAdminUsers();
            loadDepartments();
            loadManagers();
            updateStats();
            
            // Setup role-based permission selection
            const roleSelect = document.getElementById('userRole');
            if (roleSelect) {
                roleSelect.addEventListener('change', function() {
                    const role = this.value;
                    // Reset all checkboxes
                    document.querySelectorAll('#addUserModal input[type="checkbox"]').forEach(cb => cb.checked = false);
                    
                    // Set permissions based on role
                    if (role === 'super_admin') {
                        document.querySelectorAll('#addUserModal input[type="checkbox"]').forEach(cb => cb.checked = true);
                    } else if (role === 'admin') {
                        document.getElementById('permEmployees').checked = true;
                        document.getElementById('permPoints').checked = true;
                        document.getElementById('permReferrals').checked = true;
                    } else if (role === 'referrals_admin') {
                        document.getElementById('permReferrals').checked = true;
                    } else if (role === 'points_admin') {
                        document.getElementById('permPoints').checked = true;
                    }
                });
            }
        });

        function toggleEmployeeForm() {
            const form = document.getElementById('employeeFormCard');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }

        async function loadEmployees() {
            try {
                const response = await fetch(`${API_URL}/employees`);
                const data = await response.json();
                employees = data.employees || data || [];
                displayEmployees();
                populateFilters();
                updateStats();
                loadDepartments();
                loadManagers();
            } catch (error) {
                console.error('Error loading employees:', error);
                displayEmployees([]);
            }
        }

        function displayEmployees() {
            const tbody = document.getElementById('employeesTable');
            if (!employees.length) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">No employees found</td></tr>';
                return;
            }

            // Sort employees alphabetically by name by default
            const sortedEmployees = [...employees].sort((a, b) => {
                const nameA = (a['First Name'] && a['Last Name'] ? 
                    `${a['First Name']} ${a['Last Name']}` : 
                    (a.name || `${a.first_name || ''} ${a.last_name || ''}`)).toLowerCase();
                const nameB = (b['First Name'] && b['Last Name'] ? 
                    `${b['First Name']} ${b['Last Name']}` : 
                    (b.name || `${b.first_name || ''} ${b.last_name || ''}`)).toLowerCase();
                
                if (sortColumn === 'name') {
                    return sortDirection === 'asc' ? nameA.localeCompare(nameB) : nameB.localeCompare(nameA);
                } else if (sortColumn === 'id') {
                    const idA = (a.employee_id || a.id || '').toString();
                    const idB = (b.employee_id || b.id || '').toString();
                    return sortDirection === 'asc' ? idA.localeCompare(idB) : idB.localeCompare(idA);
                } else if (sortColumn === 'department') {
                    const deptA = (a['Department'] || a.department || '').toLowerCase();
                    const deptB = (b['Department'] || b.department || '').toLowerCase();
                    return sortDirection === 'asc' ? deptA.localeCompare(deptB) : deptB.localeCompare(deptA);
                } else if (sortColumn === 'manager') {
                    const mgrA = (a.manager || a.supervisor || '').toLowerCase();
                    const mgrB = (b.manager || b.supervisor || '').toLowerCase();
                    return sortDirection === 'asc' ? mgrA.localeCompare(mgrB) : mgrB.localeCompare(mgrA);
                } else if (sortColumn === 'office') {
                    const officeA = (a.office || '').toLowerCase();
                    const officeB = (b.office || '').toLowerCase();
                    return sortDirection === 'asc' ? officeA.localeCompare(officeB) : officeB.localeCompare(officeA);
                } else if (sortColumn === 'status') {
                    const statusA = ((a['Terminated'] || a.terminated || 'No') === 'Yes' ? 'terminated' : 'active');
                    const statusB = ((b['Terminated'] || b.terminated || 'No') === 'Yes' ? 'terminated' : 'active');
                    return sortDirection === 'asc' ? statusA.localeCompare(statusB) : statusB.localeCompare(statusA);
                } else if (sortColumn === 'points') {
                    const pointsA = parseInt(a.points || a['Panda Points'] || 0);
                    const pointsB = parseInt(b.points || b['Panda Points'] || 0);
                    return sortDirection === 'asc' ? pointsA - pointsB : pointsB - pointsA;
                }
                return nameA.localeCompare(nameB);
            });

            tbody.innerHTML = sortedEmployees.map(emp => {
                const firstName = emp['First Name'] || emp.first_name || '';
                const lastName = emp['Last Name'] || emp.last_name || '';
                
                // Build full name properly
                let displayName = '';
                if (firstName && lastName) {
                    displayName = `${firstName} ${lastName}`;
                } else if (firstName) {
                    displayName = firstName;
                } else if (lastName) {
                    displayName = lastName;
                } else {
                    displayName = emp.name || 'Unknown Employee';
                }
                
                const email = emp['Email'] || emp.email || '-';
                const empId = emp.employee_id || emp.id || '-';
                const department = emp['Department'] || emp.department || '-';
                const manager = emp.manager || emp.supervisor || '-';
                const office = emp.office || '-';
                const terminated = emp['Terminated'] || emp.terminated || 'No';
                const status = terminated === 'Yes' ? 'terminated' : 'active';
                const lastLogin = emp.last_login ? new Date(emp.last_login).toLocaleDateString() : 'Never';
                
                return `
                    <tr>
                        <td>
                            <div>
                                <strong>${displayName}</strong>
                                <br><small class="text-muted">${email}</small>
                                <br><small class="text-muted">Last login: ${lastLogin}</small>
                            </div>
                        </td>
                        <td>${empId}</td>
                        <td>${department}</td>
                        <td>${manager}</td>
                        <td>${office}</td>
                        <td><span class="badge bg-${status === 'active' ? 'success' : 'danger'}">${status}</span></td>
                        <td><span class="badge bg-warning text-dark">${emp.points || emp['Panda Points'] || 0} pts</span></td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" data-emp-id="${empId}" onclick="editEmployee(this.getAttribute('data-emp-id'))">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-success" data-emp-id="${empId}" onclick="awardPoints(this.getAttribute('data-emp-id'))">
                                    <i class="fas fa-star"></i>
                                </button>
                                <button class="btn btn-outline-danger" data-emp-id="${empId}" onclick="deleteEmployee(this.getAttribute('data-emp-id'))">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function populateFilters() {
            const deptFilter = document.getElementById('departmentFilter');
            const empDept = document.getElementById('empDepartment');
            
            const uniqueDepts = [...new Set(employees.map(e => e['Department'] || e.department).filter(Boolean))];
            
            [deptFilter, empDept].forEach(select => {
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = select.id === 'departmentFilter' ? '<option value="">All Departments</option>' : '<option value="">Select Department</option>';
                    uniqueDepts.forEach(dept => {
                        select.innerHTML += `<option value="${dept}">${dept}</option>`;
                    });
                    departments.forEach(dept => {
                        if (!uniqueDepts.includes(dept)) {
                            select.innerHTML += `<option value="${dept}">${dept}</option>`;
                        }
                    });
                    select.value = currentValue;
                }
            });
            
            // Populate manager dropdown - alphabetically sorted
            const empManager = document.getElementById('empManager');
            const editManager = document.getElementById('editManager');
            const uniqueManagers = [...new Set(employees.map(e => {
                const name = e['First Name'] && e['Last Name'] ? 
                    `${e['First Name']} ${e['Last Name']}` : 
                    (e.name || `${e.first_name || ''} ${e.last_name || ''}`);
                return name;
            }).filter(Boolean))].sort((a, b) => a.localeCompare(b));
            
            [empManager, editManager].forEach(select => {
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Select Manager</option>';
                    uniqueManagers.forEach(manager => {
                        select.innerHTML += `<option value="${manager}">${manager}</option>`;
                    });
                    select.value = currentValue;
                }
            });
        }

        function filterEmployees() {
            const search = document.getElementById('employeeSearch').value.toLowerCase();
            const dept = document.getElementById('departmentFilter').value;
            const status = document.getElementById('statusFilter').value;
            const office = document.getElementById('officeFilter').value;

            const filteredEmployees = employees.filter(emp => {
                const name = (emp['First Name'] && emp['Last Name'] ? 
                    `${emp['First Name']} ${emp['Last Name']}` : 
                    (emp.name || `${emp.first_name || ''} ${emp.last_name || ''}`)).toLowerCase();
                const email = (emp['Email'] || emp.email || '').toLowerCase();
                const empId = (emp.employee_id || emp.id || '').toLowerCase();
                const department = emp['Department'] || emp.department || '';
                const empOffice = emp.office || '';
                const terminated = emp['Terminated'] || emp.terminated || 'No';
                const empStatus = terminated === 'Yes' ? 'terminated' : 'active';

                const matchesSearch = !search || name.includes(search) || email.includes(search) || empId.includes(search);
                const matchesDept = !dept || department === dept;
                const matchesStatus = !status || empStatus === status;
                const matchesOffice = !office || empOffice === office;

                return matchesSearch && matchesDept && matchesStatus && matchesOffice;
            });

            // Temporarily store original employees and display filtered
            const originalEmployees = employees;
            employees = filteredEmployees;
            displayEmployees();
            employees = originalEmployees;
        }

        async function createEmployee() {
            const form = document.getElementById('newEmployeeForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const employee = {
                first_name: document.getElementById('empFirstName').value,
                last_name: document.getElementById('empLastName').value,
                email: document.getElementById('empEmail').value,
                phone: document.getElementById('empPhone').value,
                department: document.getElementById('empDepartment').value,
                manager: document.getElementById('empManager').value,
                office: document.getElementById('empOffice').value,
                position: document.getElementById('empTitle').value,
                employment_date: document.getElementById('empHireDate').value || new Date().toISOString().split('T')[0],
                terminated: document.getElementById('empStatus').value === 'terminated' ? 'Yes' : 'No'
            };

            try {
                const response = await fetch(`${API_URL}/employees`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(employee)
                });

                if (response.ok) {
                    showToast('Employee created successfully!', 'success');
                    resetEmployeeForm();
                    loadEmployees();
                } else {
                    throw new Error('Failed to create employee');
                }
            } catch (error) {
                showToast('Error creating employee: ' + error.message, 'error');
            }
        }

        function resetEmployeeForm() {
            document.getElementById('newEmployeeForm').reset();
            document.getElementById('employeeFormCard').style.display = 'none';
        }

        function refreshEmployees() {
            loadEmployees();
        }

        function updateStats() {
            const total = employees.length;
            const active = employees.filter(e => {
                const terminated = e['Terminated'] || e.terminated || 'No';
                return terminated === 'No';
            }).length;
            const depts = new Set(employees.map(e => e['Department'] || e.department).filter(Boolean)).size;
            
            document.getElementById('totalEmployees').textContent = total;
            document.getElementById('activeEmployees').textContent = active;
            document.getElementById('totalDepartments').textContent = depts;
            
            // Load admin users count
            fetch(`${API_URL}/admin-users`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('totalAdmins').textContent = data.users ? data.users.length : 0;
                })
                .catch(() => {
                    document.getElementById('totalAdmins').textContent = '0';
                });
        }
        
        async function loadAdminUsers() {
            try {
                const response = await fetch(`${API_URL}/admin-users`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                const tbody = document.getElementById('adminUsersTable');
                if (data.users && data.users.length > 0) {
                    tbody.innerHTML = data.users.map(user => `
                        <tr>
                            <td>
                                <div>
                                    <strong>${user.name || user.email}</strong>
                                    <br><small class="text-muted">${user.email}</small>
                                </div>
                            </td>
                            <td><span class="badge bg-primary">${user.role}</span></td>
                            <td><span class="badge ${user.active ? 'bg-success' : 'bg-secondary'}">${user.active ? 'Active' : 'Inactive'}</span></td>
                            <td>${user.created_at ? new Date(user.created_at).toLocaleDateString() : 'N/A'}</td>
                            <td>N/A</td>
                            <td>
                                <button class="btn btn-sm btn-outline-info" onclick="viewAdminDetails('${user.email}')">
                                    <i class="fas fa-eye"></i> View
                                </button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">No admin users found</td></tr>';
                }
            } catch (error) {
                console.error('Error loading admin users:', error);
                document.getElementById('adminUsersTable').innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error loading admin users</td></tr>';
            }
        }
        
        function showAddUserModal() {
            new bootstrap.Modal(document.getElementById('addUserModal')).show();
        }
        
        async function addAdminUser() {
            const email = document.getElementById('userEmail').value;
            const password = document.getElementById('userPassword').value;
            const role = document.getElementById('userRole').value;
            
            if (!email || !password) {
                showToast('Please fill in all fields', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/admin-users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, role })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('Admin user created successfully', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
                    document.getElementById('addUserForm').reset();
                    loadAdminUsers();
                    updateStats();
                } else {
                    showToast('Error: ' + (result.message || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error creating admin user:', error);
                showToast('Error creating admin user: ' + error.message, 'error');
            }
        }

        function loadDepartments() {
            const container = document.getElementById('departmentsList');
            const actualDepts = [...new Set(employees.map(e => e['Department'] || e.department).filter(Boolean))];
            const deptCounts = {};
            
            employees.forEach(emp => {
                const dept = emp['Department'] || emp.department;
                if (dept) {
                    deptCounts[dept] = (deptCounts[dept] || 0) + 1;
                }
            });
            
            container.innerHTML = actualDepts.map(dept => `
                <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                    <div>
                        <strong>${dept}</strong>
                        <br><small class="text-muted">${deptCounts[dept]} employees</small>
                    </div>
                    <button class="btn btn-sm btn-outline-primary" onclick="viewDepartmentEmployees('${dept}')">
                        <i class="fas fa-users"></i> View
                    </button>
                </div>
            `).join('');
        }

        function loadManagers() {
            const uniqueSupervisors = [...new Set(employees.map(e => e.supervisor).filter(Boolean))].sort((a, b) => a.localeCompare(b));
            
            const container = document.getElementById('managersList');
            container.innerHTML = uniqueSupervisors.map(supervisor => {
                const teamMembers = employees.filter(e => e.supervisor === supervisor);
                const teamSize = teamMembers.length;
                return `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                        <div>
                            <strong>${supervisor}</strong>
                            <br><small class="text-muted">Team: ${teamSize} employees</small>
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewManagerTeam('${supervisor}')">
                            <i class="fas fa-users"></i> View Team
                        </button>
                    </div>
                `;
            }).join('');

            // Update managers table
            const tbody = document.getElementById('managersTable');
            tbody.innerHTML = uniqueSupervisors.map(supervisor => {
                const teamMembers = employees.filter(e => e.supervisor === supervisor);
                const teamSize = teamMembers.length;
                const quarterlyBudget = teamSize * 500; // $500 per employee per quarter
                const totalAwarded = teamMembers.reduce((sum, emp) => sum + (emp.points || emp['Panda Points'] || 0), 0);
                const remaining = quarterlyBudget - totalAwarded;
                const departments = [...new Set(teamMembers.map(e => e['Department'] || e.department).filter(Boolean))];
                return `
                    <tr>
                        <td>${supervisor}</td>
                        <td>${departments.join(', ') || 'Multiple'}</td>
                        <td>${teamSize}</td>
                        <td>$${quarterlyBudget.toLocaleString()}</td>
                        <td>$${totalAwarded.toLocaleString()}</td>
                        <td class="${remaining < 0 ? 'text-danger' : 'text-success'}">$${remaining.toLocaleString()}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="adjustBudget('${supervisor}', ${quarterlyBudget}, ${totalAwarded})">
                                <i class="fas fa-edit"></i> Adjust
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function showAddDepartment() {
            showModal('Add New Department', `
                <div class="mb-3">
                    <label class="form-label">Department Name</label>
                    <input type="text" class="form-control" id="newDeptName" placeholder="Enter department name">
                </div>
            `, () => {
                const name = document.getElementById('newDeptName').value.trim();
                if (name && !departments.includes(name)) {
                    departments.push(name);
                    loadDepartments();
                    populateFilters();
                    showToast('Department added successfully', 'success');
                } else if (departments.includes(name)) {
                    showToast('Department already exists', 'warning');
                } else {
                    showToast('Please enter a department name', 'warning');
                }
            });
        }

        function editDepartment(dept) {
            const newName = prompt('Edit department name:', dept);
            if (newName && newName !== dept) {
                const index = departments.indexOf(dept);
                if (index > -1) departments[index] = newName;
                loadDepartments();
                populateFilters();
            }
        }

        function deleteDepartment(dept) {
            if (confirm(`Delete department "${dept}"?`)) {
                departments = departments.filter(d => d !== dept);
                loadDepartments();
                populateFilters();
            }
        }

        function viewManagerTeam(supervisor) {
            const team = employees.filter(e => e.supervisor === supervisor);
            const teamList = team.map(e => {
                const name = e['First Name'] && e['Last Name'] ? `${e['First Name']} ${e['Last Name']}` : e.name;
                const dept = e['Department'] || e.department || 'Unknown';
                const points = e.points || e['Panda Points'] || 0;
                return `
                    <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                        <div>
                            <strong>${name}</strong><br>
                            <small class="text-muted">${dept}</small>
                        </div>
                        <span class="badge bg-warning text-dark">${points} pts</span>
                    </div>
                `;
            }).join('');
            
            showModal(`${supervisor}'s Team (${team.length} employees)`, `
                <div class="team-list" style="max-height: 400px; overflow-y: auto;">
                    ${teamList}
                </div>
            `);
        }

        function viewDepartmentEmployees(department) {
            const deptEmployees = employees.filter(e => (e['Department'] || e.department) === department);
            const empList = deptEmployees.map(e => {
                const name = e['First Name'] && e['Last Name'] ? `${e['First Name']} ${e['Last Name']}` : e.name;
                const supervisor = e.supervisor || 'No supervisor';
                const points = e.points || e['Panda Points'] || 0;
                return `
                    <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                        <div>
                            <strong>${name}</strong><br>
                            <small class="text-muted">${supervisor}</small>
                        </div>
                        <span class="badge bg-warning text-dark">${points} pts</span>
                    </div>
                `;
            }).join('');
            
            showModal(`${department} Department (${deptEmployees.length} employees)`, `
                <div class="dept-list" style="max-height: 400px; overflow-y: auto;">
                    ${empList}
                </div>
            `);
        }

        function adjustBudget(manager, currentBudget, totalAwarded) {
            const teamMembers = employees.filter(e => e.supervisor === manager);
            const teamList = teamMembers.map(emp => {
                const name = emp['First Name'] && emp['Last Name'] ? `${emp['First Name']} ${emp['Last Name']}` : emp.name;
                const empId = emp.id || emp.employee_id;
                const points = emp.points || emp['Panda Points'] || 0;
                const dept = emp['Department'] || emp.department || 'Unknown';
                return `
                    <div class="row align-items-center mb-2 p-2 border rounded">
                        <div class="col-md-4">
                            <strong>${name}</strong><br>
                            <small class="text-muted">${dept}</small>
                        </div>
                        <div class="col-md-3">
                            <span class="badge bg-warning text-dark">${points} pts</span>
                        </div>
                        <div class="col-md-3">
                            <input type="number" class="form-control form-control-sm" id="budget_${empId}" value="500" min="0" placeholder="Budget">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="adjustIndividualPoints('${empId}', '${name}')">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            showModal(`Budget Adjustment - ${manager}`, `
                <div class="mb-3">
                    <h6>Team Overview</h6>
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>Total Budget:</strong> $${currentBudget.toLocaleString()}</div>
                        <div class="col-md-4"><strong>Awarded:</strong> $${totalAwarded.toLocaleString()}</div>
                        <div class="col-md-4"><strong>Remaining:</strong> $${(currentBudget - totalAwarded).toLocaleString()}</div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <h6>Team Members (${teamMembers.length})</h6>
                    <div class="row mb-2 text-muted">
                        <div class="col-md-4">Employee</div>
                        <div class="col-md-3">Current Points</div>
                        <div class="col-md-3">Individual Budget</div>
                        <div class="col-md-2">Actions</div>
                    </div>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${teamList}
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Quarterly Budget per Employee</label>
                    <input type="number" class="form-control" id="budgetPerEmployee" value="500" min="0">
                    <small class="text-muted">Default budget amount per employee per quarter</small>
                </div>
            `, () => {
                const budgetPerEmployee = parseInt(document.getElementById('budgetPerEmployee').value) || 500;
                const updates = [];
                
                teamMembers.forEach(emp => {
                    const empId = emp.id || emp.employee_id;
                    const individualBudget = parseInt(document.getElementById(`budget_${empId}`).value) || budgetPerEmployee;
                    if (individualBudget !== 500) {
                        updates.push({ empId, budget: individualBudget });
                    }
                });
                
                if (updates.length > 0) {
                    showToast(`Updated individual budgets for ${updates.length} employees`, 'success');
                } else {
                    showToast('Budget settings updated successfully', 'success');
                }
                loadManagers();
            });
        }

        // Bulk operations
        function bulkImportEmployees() {
            showToast('Bulk import feature - Integration with file upload system', 'info');
        }

        function exportEmployees() {
            const csv = 'Name,Email,EmployeeID,Department,Manager,Office,Status\n' +
                employees.map(e => {
                    const name = e['First Name'] && e['Last Name'] ? `${e['First Name']} ${e['Last Name']}` : e.name || '';
                    const email = e['Email'] || e.email || '';
                    const empId = e.employee_id || e.id || '';
                    const dept = e['Department'] || e.department || '';
                    const manager = e.supervisor || e.manager || '';
                    const office = e.office || '';
                    const status = (e['Terminated'] || e.terminated || 'No') === 'Yes' ? 'Terminated' : 'Active';
                    return `"${name}","${email}","${empId}","${dept}","${manager}","${office}","${status}"`;
                }).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `employees_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Employee data exported successfully', 'success');
        }

        function exportDepartments() {
            showToast('Export departments feature - Coming soon!', 'info');
        }

        function exportPointsReport() {
            showToast('Export points report feature - Coming soon!', 'info');
        }

        function bulkUpdateDepartments() {
            showToast('Bulk update departments feature - Coming soon!', 'info');
        }

        function bulkAssignManagers() {
            showToast('Bulk assign managers feature - Coming soon!', 'info');
        }

        function bulkAwardPoints() {
            showToast('Bulk award points feature - Coming soon!', 'info');
        }
        
        function adjustIndividualPoints(empId, empName) {
            const employee = employees.find(e => (e.id || e.employee_id) === empId);
            if (!employee) return;
            
            const currentPoints = employee.points || employee['Panda Points'] || 0;
            
            showModal(`Adjust Points - ${empName}`, `
                <div class="mb-3">
                    <label class="form-label">Current Points Balance</label>
                    <input type="number" class="form-control" id="newPointsBalance" value="${currentPoints}" min="0">
                    <small class="text-muted">Set the new points balance for this employee</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">Reason for Adjustment</label>
                    <textarea class="form-control" id="adjustmentReason" rows="2" placeholder="e.g., Correction, bonus points, etc."></textarea>
                </div>
            `, async () => {
                const newBalance = parseInt(document.getElementById('newPointsBalance').value) || 0;
                const reason = document.getElementById('adjustmentReason').value.trim();
                
                try {
                    const response = await fetch(`${API_URL}/employees/${empId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            'points': newBalance,
                            'Panda Points': newBalance
                        })
                    });
                    
                    if (response.ok) {
                        showToast(`Points balance updated to ${newBalance} for ${empName}`, 'success');
                        await loadEmployees();
                        loadManagers();
                    } else {
                        throw new Error('Failed to update points');
                    }
                } catch (error) {
                    showToast('Error updating points: ' + error.message, 'error');
                }
            });
        }
        
        function toggleBudgetField() {
            const pointsManager = document.getElementById('editPointsManager');
            const budgetContainer = document.getElementById('budgetFieldContainer');
            if (pointsManager && budgetContainer) {
                budgetContainer.style.display = (pointsManager.value === 'Yes') ? 'block' : 'none';
            }
        }
        
        async function loadLoginHistory(empId) {
            const tbody = document.getElementById('loginHistoryTable');
            
            try {
                const response = await fetch(`${API_URL}/login-history/${empId}`);
                if (response.ok) {
                    const data = await response.json();
                    const history = data.history || [];
                    
                    if (history.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No login history available</td></tr>';
                    } else {
                        tbody.innerHTML = history.map(login => `
                            <tr>
                                <td>${new Date(login.timestamp).toLocaleDateString()}</td>
                                <td>${new Date(login.timestamp).toLocaleTimeString()}</td>
                                <td><span class="badge bg-${login.status === 'Success' ? 'success' : 'danger'}">${login.status}</span></td>
                                <td>${login.source || 'Employee portal'}</td>
                            </tr>
                        `).join('');
                    }
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Unable to load login history</td></tr>';
                }
            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No login history available</td></tr>';
            }
        }
        
        function showAddManager() {
            const availableEmployees = employees.filter(e => {
                const terminated = e['Terminated'] || e.terminated || 'No';
                return terminated === 'No';
            }).sort((a, b) => {
                const nameA = `${a['First Name'] || ''} ${a['Last Name'] || ''}`.trim();
                const nameB = `${b['First Name'] || ''} ${b['Last Name'] || ''}`.trim();
                return nameA.localeCompare(nameB);
            });
            
            const employeeOptions = availableEmployees.map(emp => {
                const name = `${emp['First Name'] || ''} ${emp['Last Name'] || ''}`.trim();
                const dept = emp['Department'] || emp.department || 'No Department';
                return `<option value="${name}">${name} (${dept})</option>`;
            }).join('');
            
            showModal('Add Manager', `
                <div class="mb-3">
                    <label class="form-label">Select Employee to Promote to Manager</label>
                    <select class="form-select" id="newManagerSelect">
                        <option value="">Choose an employee...</option>
                        ${employeeOptions}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Department</label>
                    <select class="form-select" id="managerDepartment">
                        <option value="">Select Department</option>
                        ${[...new Set(employees.map(e => e['Department'] || e.department).filter(Boolean))].map(dept => 
                            `<option value="${dept}">${dept}</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    This will update the employee's supervisor status and allow them to manage team members.
                </div>
            `, async () => {
                const selectedManager = document.getElementById('newManagerSelect').value;
                const department = document.getElementById('managerDepartment').value;
                
                if (!selectedManager) {
                    showToast('Please select an employee', 'warning');
                    return;
                }
                
                if (!department) {
                    showToast('Please select a department', 'warning');
                    return;
                }
                
                // Find the employee and update their supervisor status
                const employee = employees.find(e => {
                    const firstName = e['First Name'] || e.first_name || '';
                    const lastName = e['Last Name'] || e.last_name || '';
                    const name = `${firstName} ${lastName}`.trim();
                    return name === selectedManager;
                });
                
                console.log('Found employee for promotion:', employee);
                
                if (employee) {
                    try {
                        const empId = employee['Employee Id'] || employee.employee_id || employee.id;
                        console.log('Promoting employee to manager:', empId, selectedManager, department);
                        
                        const response = await fetch(`${API_URL}/employees/${empId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                'is_supervisor': 'Yes',
                                'Department': department,
                                'points_manager': 'Yes',
                                'points_budget': 500
                            })
                        });
                        
                        console.log('Manager promotion response:', response.status);
                        const responseText = await response.text();
                        console.log('Manager promotion response text:', responseText);
                        
                        if (response.ok) {
                            showToast(`${selectedManager} has been promoted to manager of ${department}`, 'success');
                            await loadEmployees();
                            loadManagers();
                        } else {
                            throw new Error(`Failed to update employee: ${responseText}`);
                        }
                    } catch (error) {
                        console.error('Manager promotion error:', error);
                        showToast('Error promoting employee to manager: ' + error.message, 'error');
                    }
                }
            });
        }

        async function editEmployee(empId) {
            const employee = employees.find(e => (e.employee_id || e.id) === empId);
            if (!employee) {
                showToast('Employee not found', 'error');
                return;
            }

            // Populate edit form
            document.getElementById('editEmpId').value = empId;
            document.getElementById('editFirstName').value = employee['First Name'] || employee.first_name || '';
            document.getElementById('editLastName').value = employee['Last Name'] || employee.last_name || '';
            document.getElementById('editEmail').value = employee['Email'] || employee.email || '';
            document.getElementById('editEmployeeId').value = empId;
            
            // Populate department dropdown for edit form
            const editDept = document.getElementById('editDepartment');
            if (editDept) {
                editDept.innerHTML = '<option value="">Select Department</option>';
                const uniqueDepts = [...new Set(employees.map(e => e['Department'] || e.department).filter(Boolean))];
                [...uniqueDepts, ...departments].forEach(dept => {
                    if (dept) editDept.innerHTML += `<option value="${dept}">${dept}</option>`;
                });
                editDept.value = employee['Department'] || employee.department || '';
            }
            
            // Populate manager dropdown for edit form - alphabetically sorted
            const editMgr = document.getElementById('editManager');
            if (editMgr) {
                editMgr.innerHTML = '<option value="">Select Manager</option>';
                const uniqueManagers = [...new Set(employees.map(e => e.supervisor).filter(Boolean))].sort((a, b) => a.localeCompare(b));
                uniqueManagers.forEach(manager => {
                    editMgr.innerHTML += `<option value="${manager}">${manager}</option>`;
                });
                editMgr.value = employee.supervisor || '';
            }
            
            const terminated = employee['Terminated'] || employee.terminated || 'No';
            const editStatus = document.getElementById('editStatus');
            if (editStatus) {
                editStatus.value = terminated === 'Yes' ? 'terminated' : 'active';
            }
            
            // Set points balance and manager status
            const editPoints = document.getElementById('editPoints');
            if (editPoints) {
                editPoints.value = employee.points || employee['Panda Points'] || 0;
            }
            
            const editIsSupervisor = document.getElementById('editIsSupervisor');
            if (editIsSupervisor) {
                editIsSupervisor.value = employee.is_supervisor || 'No';
            }
            
            // Auto-detect Points Manager based on position/title
            const position = (employee['Position'] || employee.position || '').toLowerCase();
            const isPointsManagerByTitle = position.includes('director') || 
                                           position.includes('president') || 
                                           position.includes('vice president') || 
                                           position.includes('c-suite') ||
                                           position.includes('ceo') ||
                                           position.includes('cfo') ||
                                           position.includes('coo') ||
                                           position.includes('cto');
            
            const editPointsManager = document.getElementById('editPointsManager');
            if (editPointsManager) {
                editPointsManager.value = employee.points_manager || (isPointsManagerByTitle ? 'Yes' : 'No');
            }
            
            const editPointsBudget = document.getElementById('editPointsBudget');
            if (editPointsBudget) {
                editPointsBudget.value = employee.points_budget || 500;
            }
            
            // Show/hide budget field based on Points Manager status
            toggleBudgetField();
            
            // Load login history
            loadLoginHistory(empId);
            
            // Clear password field (don't show existing password)
            const editPassword = document.getElementById('editPassword');
            if (editPassword) {
                editPassword.value = '';
            }

            // Show the edit modal
            const editModal = document.getElementById('editEmployeeModal');
            if (editModal && window.bootstrap) {
                new bootstrap.Modal(editModal).show();
            } else {
                console.error('Edit modal or Bootstrap not found');
                showToast('Unable to open edit form', 'error');
            }
        }

        async function deleteEmployeeFromModal() {
            const empId = document.getElementById('editEmpId').value;
            const firstName = document.getElementById('editFirstName').value;
            const lastName = document.getElementById('editLastName').value;
            const name = `${firstName} ${lastName}`.trim() || 'Unknown Employee';
            
            if (!confirm(`Are you sure you want to permanently delete ${name}?\n\nThis action cannot be undone and will remove all employee data including points history.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/employees/${empId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    showToast(`${name} has been deleted successfully`, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('editEmployeeModal')).hide();
                    await loadEmployees();
                    updateStats();
                } else {
                    const errorText = await response.text();
                    throw new Error(`Failed to delete employee: ${errorText}`);
                }
            } catch (error) {
                console.error('Delete error:', error);
                showToast('Error deleting employee: ' + error.message, 'error');
            }
        }
        
        async function updateEmployee() {
            const empId = document.getElementById('editEmpId').value;
            const updates = {
                'First Name': document.getElementById('editFirstName').value,
                'Last Name': document.getElementById('editLastName').value,
                'Email': document.getElementById('editEmail').value,
                'Department': document.getElementById('editDepartment').value,
                'supervisor': document.getElementById('editManager').value,
                'Terminated': document.getElementById('editStatus').value === 'terminated' ? 'Yes' : 'No',
                'points': parseInt(document.getElementById('editPoints').value) || 0,
                'Panda Points': parseInt(document.getElementById('editPoints').value) || 0,
                'is_supervisor': document.getElementById('editIsSupervisor').value,
                'points_manager': document.getElementById('editPointsManager').value,
                'points_budget': parseInt(document.getElementById('editPointsBudget').value) || 500
            };
            
            // Only include password if it's been changed
            const newPassword = document.getElementById('editPassword').value.trim();
            if (newPassword) {
                updates.password = newPassword;
            }

            try {
                console.log('Updating employee:', empId, 'with data:', updates);
                const response = await fetch(`${API_URL}/employees/${empId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates)
                });

                const responseText = await response.text();
                console.log('Update response:', response.status, responseText);

                if (response.ok) {
                    showToast('Employee updated successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('editEmployeeModal')).hide();
                    await loadEmployees();
                } else {
                    throw new Error(`Server error: ${responseText}`);
                }
            } catch (error) {
                console.error('Update error:', error);
                showToast('Error updating employee: ' + error.message, 'error');
            }
        }

        async function awardPoints(empId) {
            const employee = employees.find(e => (e.employee_id || e.id) === empId);
            if (!employee) {
                showToast('Employee not found', 'error');
                return;
            }

            showModal(`Award Points to ${employee['First Name']} ${employee['Last Name']}`, `
                <div class="mb-3">
                    <label class="form-label">Points to Award</label>
                    <input type="number" class="form-control" id="pointsToAward" min="1" placeholder="Enter points amount">
                    <small class="text-muted">Current balance: ${employee.points || employee['Panda Points'] || 0} points</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">Reason (Optional)</label>
                    <input type="text" class="form-control" id="pointsReason" placeholder="e.g., Great customer service">
                </div>
            `, async () => {
                const points = parseInt(document.getElementById('pointsToAward').value);
                if (points && points > 0) {
                    const currentPoints = employee.points || employee['Panda Points'] || 0;
                    const newTotal = currentPoints + points;
                
                    try {
                        const response = await fetch(`${API_URL}/employees/${empId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                'points': newTotal,
                                'Panda Points': newTotal
                            })
                        });

                        if (response.ok) {
                            showToast(`Awarded ${points} points to ${employee['First Name']} ${employee['Last Name']}! New total: ${newTotal}`, 'success');
                            await loadEmployees();
                        } else {
                            throw new Error('Failed to award points');
                        }
                    } catch (error) {
                        showToast('Error awarding points: ' + error.message, 'error');
                    }
                } else {
                    showToast('Please enter a valid points amount', 'warning');
                }
            });
        }

        async function deleteEmployee(empId) {
            const employee = employees.find(e => (e.employee_id || e.id || e['Employee Id']) === empId);
            if (!employee) {
                showToast('Employee not found', 'error');
                return;
            }
            
            const firstName = employee['First Name'] || employee.first_name || '';
            const lastName = employee['Last Name'] || employee.last_name || '';
            const name = `${firstName} ${lastName}`.trim() || 'Unknown Employee';
            
            if (!confirm(`Are you sure you want to permanently delete ${name}?\n\nThis action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/employees/${empId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    showToast(`${name} has been deleted successfully`, 'success');
                    await loadEmployees();
                } else {
                    const errorText = await response.text();
                    throw new Error(`Failed to delete employee: ${errorText}`);
                }
            } catch (error) {
                console.error('Delete error:', error);
                showToast('Error deleting employee: ' + error.message, 'error');
            }
        }
        
        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            
            // Update sort icons
            document.querySelectorAll('[id^="sort-"]').forEach(icon => {
                icon.className = 'fas fa-sort';
            });
            
            const icon = document.getElementById(`sort-${column}`);
            if (icon) {
                icon.className = sortDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
            }
            
            displayEmployees();
        }

        function viewAdminDetails(email) {
            const admin = employees.find(e => (e.Email || e.email) === email);
            if (admin) {
                const name = admin['First Name'] && admin['Last Name'] ? 
                    `${admin['First Name']} ${admin['Last Name']}` : 'Unknown';
                const dept = admin['Department'] || admin.department || 'Unknown';
                const position = admin['Position'] || admin.position || 'Unknown';
                const hireDate = admin['Employment Date'] || admin.employment_date || 'Unknown';
                
                showModal('Admin Details', `
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Name:</strong> ${name}</p>
                            <p><strong>Email:</strong> ${email}</p>
                            <p><strong>Department:</strong> ${dept}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Position:</strong> ${position}</p>
                            <p><strong>Hire Date:</strong> ${hireDate}</p>
                        </div>
                    </div>
                `);
            } else {
                showToast('Admin details not found', 'error');
            }
        }
        
        // Modern UX Helper Functions
        function showModal(title, body, onConfirm = null) {
            document.getElementById('modernModalTitle').textContent = title;
            document.getElementById('modernModalBody').innerHTML = body;
            
            const footer = document.getElementById('modernModalFooter');
            const confirmBtn = document.getElementById('modernModalConfirm');
            
            if (onConfirm) {
                footer.style.display = 'flex';
                confirmBtn.onclick = () => {
                    onConfirm();
                    bootstrap.Modal.getInstance(document.getElementById('modernModal')).hide();
                };
            } else {
                footer.style.display = 'none';
            }
            
            new bootstrap.Modal(document.getElementById('modernModal')).show();
        }
        
        function showToast(message, type = 'info') {
            const toast = document.getElementById('liveToast');
            const toastBody = document.getElementById('toastBody');
            const toastHeader = toast.querySelector('.toast-header i');
            
            toastBody.textContent = message;
            
            // Update icon and color based on type
            toastHeader.className = `fas me-2 ${
                type === 'success' ? 'fa-check-circle text-success' :
                type === 'error' ? 'fa-exclamation-circle text-danger' :
                type === 'warning' ? 'fa-exclamation-triangle text-warning' :
                'fa-info-circle text-primary'
            }`;
            
            new bootstrap.Toast(toast).show();
        }
    </script>
</body>
</html>