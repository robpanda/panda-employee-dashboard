<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Points Dashboard - Panda Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        body { font-family: 'Inter', sans-serif; background: #fafbfc; }
        .card { border: 1px solid #f3f4f6; border-radius: 12px; }
        .btn-primary { background: #3b82f6; border-color: #3b82f6; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-star"></i> Manager Points Dashboard</h3>
                        <p class="mb-0 text-muted">Award and manage Panda Points for your team</p>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Manager Name:</label>
                            <input type="text" class="form-control" id="managerName" placeholder="Enter your name">
                            <button class="btn btn-primary mt-2" onclick="loadTeam()">Load My Team</button>
                        </div>
                        
                        <div id="teamSection" style="display: none;">
                            <h5>Your Team</h5>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th style="cursor: pointer;" onclick="sortTeam('name')">
                                                Employee <i class="fas fa-sort" id="sort-name"></i>
                                            </th>
                                            <th style="cursor: pointer;" onclick="sortTeam('department')">
                                                Department <i class="fas fa-sort" id="sort-department"></i>
                                            </th>
                                            <th style="cursor: pointer;" onclick="sortTeam('points')">
                                                Current Points <i class="fas fa-sort" id="sort-points"></i>
                                            </th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="teamTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://4ytrdf6rpklojh5c52gxpf5iei0winqx.lambda-url.us-east-2.on.aws';
        let teamMembers = [];
        let sortColumn = 'name';
        let sortDirection = 'asc';
        
        async function loadTeam() {
            const managerName = document.getElementById('managerName').value.trim();
            if (!managerName) {
                alert('Please enter your name');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/points`);
                const data = await response.json();
                
                teamMembers = data.employees.filter(emp => 
                    emp.supervisor && emp.supervisor.toLowerCase().includes(managerName.toLowerCase())
                ).sort((a, b) => a.name.localeCompare(b.name));
                
                if (teamMembers.length === 0) {
                    alert('No team members found. Please check your name spelling.');
                    return;
                }
                
                displayTeam();
                document.getElementById('teamSection').style.display = 'block';
            } catch (error) {
                alert('Error loading team data');
            }
        }
        
        function displayTeam() {
            const tbody = document.getElementById('teamTable');
            
            // Sort team members
            const sortedTeam = [...teamMembers].sort((a, b) => {
                if (sortColumn === 'name') {
                    return sortDirection === 'asc' ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name);
                } else if (sortColumn === 'department') {
                    return sortDirection === 'asc' ? a.department.localeCompare(b.department) : b.department.localeCompare(a.department);
                } else if (sortColumn === 'points') {
                    return sortDirection === 'asc' ? a.points - b.points : b.points - a.points;
                }
                return a.name.localeCompare(b.name);
            });
            
            tbody.innerHTML = sortedTeam.map(emp => `
                <tr>
                    <td>
                        <strong>${emp.name}</strong><br>
                        <small class="text-muted">ID: ${emp.employee_id}</small>
                    </td>
                    <td>${emp.department}</td>
                    <td><span class="badge bg-warning text-dark">${emp.points} pts</span></td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="awardPoints('${emp.employee_id}', '${emp.name}')">
                            <i class="fas fa-plus"></i> Award Points
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        async function awardPoints(empId, empName) {
            const points = prompt(`Award points to ${empName}:`);
            if (points && !isNaN(points) && parseInt(points) > 0) {
                const employee = teamMembers.find(e => e.employee_id === empId);
                const newTotal = employee.points + parseInt(points);
                
                try {
                    const response = await fetch(`${API_URL}/employees/${empId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            'points': newTotal,
                            'Panda Points': newTotal
                        })
                    });

                    if (response.ok) {
                        alert(`Awarded ${points} points to ${empName}! New total: ${newTotal}`);
                        loadTeam(); // Refresh the team data
                    } else {
                        throw new Error('Failed to award points');
                    }
                } catch (error) {
                    alert('Error awarding points: ' + error.message);
                }
            }
        }
        
        function sortTeam(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            
            // Update sort icons
            document.querySelectorAll('[id^="sort-"]').forEach(icon => {
                icon.className = 'fas fa-sort';
            });
            
            const icon = document.getElementById(`sort-${column}`);
            if (icon) {
                icon.className = sortDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
            }
            
            displayTeam();
        }
    </script>
</body>
</html>