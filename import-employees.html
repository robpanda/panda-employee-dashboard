<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Import Employee Data - Panda Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        body { font-family: 'Inter', sans-serif; background: #fafbfc; }
        .container { max-width: 800px; margin: 40px auto; }
        .card { border: 1px solid #f3f4f6; border-radius: 12px; }
        .btn-primary { background: #3b82f6; border-color: #3b82f6; }
        .progress { height: 8px; }
        #results { max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="card-header">
                <h3>Import Employee Data from CSV</h3>
                <p class="mb-0 text-muted">Upload the Active Headcount CSV to update employee database</p>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="csvFile" class="form-label">Select CSV File</label>
                    <input type="file" class="form-control" id="csvFile" accept=".csv" onchange="previewFile()">
                </div>
                
                <div id="preview" style="display: none;">
                    <h5>Preview (First 5 rows)</h5>
                    <div class="table-responsive mb-3">
                        <table class="table table-sm" id="previewTable"></table>
                    </div>
                    <button class="btn btn-primary" onclick="processImport()">Import Employees</button>
                </div>
                
                <div id="progress" style="display: none;">
                    <div class="progress mb-3">
                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div id="status"></div>
                </div>
                
                <div id="results" style="display: none;">
                    <h5>Import Results</h5>
                    <div id="resultContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Suppress webpack dev server console logs
        if (typeof console !== 'undefined') {
            const originalLog = console.log;
            const originalError = console.error;
            console.log = function(...args) {
                if (args[0] && typeof args[0] === 'string' && 
                    (args[0].includes('[webpack-dev-server]') || args[0].includes('[HMR]'))) {
                    return;
                }
                originalLog.apply(console, args);
            };
            console.error = function(...args) {
                if (args[0] && typeof args[0] === 'string' && 
                    (args[0].includes('WebSocket connection') || args[0].includes('webpack-dev-server'))) {
                    return;
                }
                originalError.apply(console, args);
            };
        }
        
        const API_URL = 'https://4ytrdf6rpklojh5c52gxpf5iei0winqx.lambda-url.us-east-2.on.aws';
        let csvData = [];

        function previewFile() {
            const file = document.getElementById('csvFile').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                const lines = csv.split('\n');
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                
                csvData = [];
                for (let i = 1; i < lines.length && i <= 5; i++) {
                    if (lines[i].trim()) {
                        const values = parseCSVLine(lines[i]);
                        const row = {};
                        headers.forEach((header, index) => {
                            row[header] = values[index] || '';
                        });
                        csvData.push(row);
                    }
                }

                displayPreview(headers, csvData);
                document.getElementById('preview').style.display = 'block';
            };
            reader.readAsText(file);
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim().replace(/"/g, ''));
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim().replace(/"/g, ''));
            return result;
        }

        function displayPreview(headers, data) {
            const table = document.getElementById('previewTable');
            let html = '<thead><tr>';
            headers.forEach(header => {
                html += `<th>${header}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            data.forEach(row => {
                html += '<tr>';
                headers.forEach(header => {
                    html += `<td>${row[header] || ''}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody>';
            table.innerHTML = html;
        }

        async function processImport() {
            const file = document.getElementById('csvFile').files[0];
            if (!file) return;

            document.getElementById('progress').style.display = 'block';
            document.getElementById('status').textContent = 'Reading CSV file...';
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const csv = e.target.result;
                const lines = csv.split('\n');
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                
                // Get current employees first
                document.getElementById('status').textContent = 'Loading current employees...';
                updateProgress(20);
                
                let currentEmployees = [];
                try {
                    const currentResponse = await fetch(`${API_URL}/employees`);
                    const currentData = await currentResponse.json();
                    currentEmployees = currentData.employees || [];
                } catch (error) {
                    console.log('No current employees found or error loading:', error);
                }
                
                const employees = [];
                const supervisors = new Set();
                const activeEmployeeIds = new Set();
                
                // First pass: collect all supervisors
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const values = parseCSVLine(lines[i]);
                        const supervisor = values[9] || ''; // Column J (Supervisor)
                        if (supervisor && supervisor !== '') {
                            supervisors.add(supervisor);
                        }
                    }
                }
                
                document.getElementById('status').textContent = 'Processing CSV data...';
                updateProgress(40);
                
                // Second pass: process employees
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const values = parseCSVLine(lines[i]);
                        const row = {};
                        headers.forEach((header, index) => {
                            row[header] = values[index] || '';
                        });
                        
                        const employeeId = row['Employee Id'] || '';
                        if (employeeId) {
                            activeEmployeeIds.add(employeeId);
                        }
                        
                        const fullName = `${row['Last Name']}, ${row['First Name']}`;
                        
                        // Map CSV data to employee format
                        const employee = {
                            'Employee Id': employeeId,
                            'First Name': row['First Name'] || '',
                            'Last Name': row['Last Name'] || '',
                            'Email': row['Current Home Email'] || '',
                            'Department': row['Department Description'] || '',
                            'Position': row['Position Description'] || '',
                            'Employment Date': formatDate(row['Hire Date']) || '',
                            'Phone': '',
                            'Terminated': row['Employee Status Code'] === 'A' ? 'No' : 'Yes',
                            'office': row['Current Work Location Name'] || '',
                            'supervisor': row['Supervisor'] || '',
                            'is_supervisor': supervisors.has(fullName) ? 'Yes' : 'No',
                            'Merch Requested': '',
                            'Merch Sent': 'No',
                            'Merch Sent Date': '',
                            'Termination Date': ''
                        };
                        
                        employees.push(employee);
                    }
                }
                
                // Mark employees not in CSV as terminated
                const terminatedEmployees = [];
                currentEmployees.forEach(emp => {
                    const empId = emp['Employee Id'] || emp.employee_id || emp.id;
                    if (empId && !activeEmployeeIds.has(empId)) {
                        const terminatedEmp = { ...emp };
                        terminatedEmp['Terminated'] = 'Yes';
                        terminatedEmp['Termination Date'] = new Date().toISOString().split('T')[0];
                        terminatedEmployees.push(terminatedEmp);
                    }
                });
                
                // Combine active and terminated employees
                const allEmployees = [...employees, ...terminatedEmployees];

                document.getElementById('status').textContent = `Importing ${allEmployees.length} employees...`;
                updateProgress(70);

                try {
                    console.log('IMPORT: Sending', allEmployees.length, 'employees');
                    console.log('IMPORT: Sample employee:', allEmployees[0]);
                    
                    const response = await fetch(`${API_URL}/employees`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({ employees: allEmployees })
                    });

                    updateProgress(100);
                    
                    console.log('IMPORT: Response status:', response.status);
                    const responseText = await response.text();
                    console.log('IMPORT: Response body:', responseText);
                    
                    if (response.ok) {
                        const result = JSON.parse(responseText);
                        showResults(`✅ Import completed: ${result.message}`, employees, supervisors, terminatedEmployees);
                    } else {
                        throw new Error(`HTTP ${response.status}: ${responseText}`);
                    }
                } catch (error) {
                    console.error('IMPORT ERROR:', error);
                    showResults(`❌ Import failed: ${error.message}`, [], new Set(), []);
                }
            };
            reader.readAsText(file);
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            try {
                const date = new Date(dateStr);
                return date.toISOString().split('T')[0];
            } catch {
                return dateStr;
            }
        }

        function updateProgress(percent) {
            document.querySelector('.progress-bar').style.width = percent + '%';
        }

        function showResults(message, employees, supervisors, terminatedEmployees = []) {
            document.getElementById('progress').style.display = 'none';
            document.getElementById('results').style.display = 'block';
            
            let html = `<div class="alert alert-success">${message}</div>`;
            
            if (employees.length > 0 || terminatedEmployees.length > 0) {
                html += `<h6>Import Summary:</h6>`;
                html += `<ul>`;
                html += `<li>Active Employees from CSV: ${employees.length}</li>`;
                html += `<li>Employees marked as Terminated: ${terminatedEmployees.length}</li>`;
                html += `<li>Total Records Updated: ${employees.length + terminatedEmployees.length}</li>`;
                html += `<li>Supervisors Identified: ${supervisors.size}</li>`;
                html += `</ul>`;
                
                if (terminatedEmployees.length > 0) {
                    html += `<h6 class="text-warning">Terminated Employees:</h6>`;
                    html += `<div class="alert alert-warning"><small>`;
                    terminatedEmployees.slice(0, 10).forEach(emp => {
                        const name = emp['First Name'] && emp['Last Name'] ? 
                            `${emp['First Name']} ${emp['Last Name']}` : 
                            (emp.name || 'Unknown');
                        html += `${name}<br>`;
                    });
                    if (terminatedEmployees.length > 10) {
                        html += `... and ${terminatedEmployees.length - 10} more`;
                    }
                    html += `</small></div>`;
                }
                
                html += `<h6>Departments:</h6>`;
                const depts = [...new Set(employees.map(e => e.Department).filter(Boolean))];
                html += `<div class="d-flex flex-wrap gap-1">`;
                depts.forEach(dept => {
                    html += `<span class="badge bg-secondary">${dept}</span>`;
                });
                html += `</div>`;
                
                html += `<h6 class="mt-3">Work Locations:</h6>`;
                const locations = [...new Set(employees.map(e => e.office).filter(Boolean))];
                html += `<div class="d-flex flex-wrap gap-1">`;
                locations.forEach(loc => {
                    html += `<span class="badge bg-info">${loc}</span>`;
                });
                html += `</div>`;
                
                html += `<div class="mt-3">`;
                html += `<button class="btn btn-primary" onclick="window.close()">Close & Return to Admin</button>`;
                html += `<button class="btn btn-secondary ms-2" onclick="location.reload()">Import Another File</button>`;
                html += `</div>`;
            }
            
            document.getElementById('resultContent').innerHTML = html;
        }

        // Add console logging for debugging
        window.addEventListener('error', function(e) {
            console.error('Page error:', e.error);
        });
    </script>
</body>
</html>