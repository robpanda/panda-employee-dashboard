<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panda Exteriors Employee Management</title>
    <!-- Cache bust: 2025-09-26-14:30 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #fafbfc;
            color: #374151;
            font-weight: 400;
        }
        .navbar {
            background: white !important;
            border-bottom: 1px solid #f3f4f6;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
        }
        .navbar-brand { 
            font-weight: 600;
            color: #111827 !important;
        }
        .nav-link {
            color: #6b7280 !important;
            font-weight: 400;
            border-radius: 8px;
            transition: all 0.15s ease;
        }
        .nav-link:hover {
            background: #f9fafb !important;
            color: #374151 !important;
        }
        .nav-link.active {
            background: #3b82f6 !important;
            color: white !important;
            font-weight: 500;
        }
        .card { 
            border: 1px solid #f3f4f6;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
            border-radius: 12px;
            transition: all 0.15s ease;
            background: white;
        }
        .card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-color: #e5e7eb;
        }
        .card-header {
            background: #fafbfc;
            border-bottom: 1px solid #f3f4f6;
            font-weight: 500;
            color: #374151;
        }
        .table th { 
            background: #fafbfc;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 500;
            color: #374151;
            font-size: 14px;
        }
        .table td {
            border-bottom: 1px solid #f3f4f6;
            font-size: 14px;
        }
        .form-control, .form-select {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            transition: all 0.15s ease;
        }
        .form-control:focus, .form-select:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .btn {
            font-weight: 400;
            border-radius: 8px;
            transition: all 0.15s ease;
        }
        .btn-primary {
            background: #3b82f6;
            border-color: #3b82f6;
        }
        .btn-primary:hover {
            background: #2563eb;
            border-color: #2563eb;
        }
        .btn-success {
            background: #10b981;
            border-color: #10b981;
        }
        .btn-success:hover {
            background: #059669;
            border-color: #059669;
        }
        .badge {
            font-weight: 400;
            font-size: 12px;
        }
        .sortable { 
            cursor: pointer; 
            user-select: none; 
            transition: all 0.15s ease;
        }
        .sortable:hover { 
            background-color: #f9fafb; 
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow">
        <div class="container">
            <a class="navbar-brand" href="./"><i class="fas fa-users me-2"></i>Panda Exteriors</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link active" href="dashboard.html"><i class="fas fa-users me-1"></i>Employees</a>
                <a class="nav-link" href="leads.html"><i class="fas fa-chart-line me-1"></i>Leads</a>
                <a class="nav-link" href="referrals.html"><i class="fas fa-handshake me-1"></i>Referrals</a>
                <a class="nav-link" href="./"><i class="fas fa-home me-1"></i>Portal</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="display-6 fw-bold text-primary mb-0">Employee Dashboard</h1>
                    <div class="badge bg-primary fs-6 px-3 py-2">Total: <span id="totalCount">0</span></div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-8">
                        <div class="card shadow-sm">
                            <div class="card-body py-3">
                                <div class="row g-3 align-items-center">
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <span class="input-group-text bg-light"><i class="fas fa-search"></i></span>
                                            <input type="text" class="form-control" id="searchInput" placeholder="Search employees..." onkeyup="filterEmployees()">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="officeFilter" onchange="filterEmployees()">
                                            <option value="">All Offices</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="roleFilter" onchange="filterEmployees()">
                                            <option value="">All Roles</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card shadow-sm">
                            <div class="card-body text-center">
                                <h5 class="card-title"><i class="fas fa-box text-primary"></i> Asset Management</h5>
                                <p class="card-text">Manage company assets and inventory</p>
                                <a href="assets.html" class="btn btn-primary">View Assets</a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <h5 class="card-title"><i class="fas fa-star text-warning"></i> My Panda Points</h5>
                                        <p class="card-text">Award points to employees for outstanding performance</p>
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <select class="form-select" id="employeeSelect">
                                                    <option value="">Select Employee...</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <input type="number" class="form-control" id="pointsAmount" placeholder="Points" min="1" max="100">
                                            </div>
                                            <div class="col-md-3">
                                                <button class="btn btn-warning" onclick="awardPoints()">Award Points</button>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <textarea class="form-control" id="pointsReason" placeholder="Reason for award (optional)" rows="2"></textarea>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="text-center">
                                            <h6>Manager: Rob Winters</h6>
                                            <div class="badge bg-warning fs-6 px-3 py-2">Quarterly Budget: <span id="managerBudget">500</span></div>
                                            <div class="badge bg-info fs-6 px-3 py-2 mt-2">Remaining: <span id="remainingBudget">500</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <ul class="nav nav-pills nav-fill mb-4" id="mainTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="active-employees-tab" data-bs-toggle="tab" data-bs-target="#active-employees" type="button" role="tab">
                            <i class="fas fa-users me-2"></i>Active Employees <span class="badge bg-success ms-2" id="activeCount">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="terminated-employees-tab" data-bs-toggle="tab" data-bs-target="#terminated-employees" type="button" role="tab">
                            <i class="fas fa-user-times me-2"></i>Terminated Employees <span class="badge bg-danger ms-2" id="terminatedCount">0</span>
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="mainTabContent">
                    <div class="tab-pane fade show active" id="active-employees" role="tabpanel">
                        <div class="card shadow-sm">
                            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-users me-2"></i>Active Employees</h5>
                                <div>
                                    <button class="btn btn-outline-light btn-sm me-2" onclick="clearFilters()">Clear Filters</button>
                                    <button class="btn btn-warning btn-sm me-2" onclick="importFromGoogleSheets()">Sync Google Sheets</button>
                                    <a href="admin.html" class="btn btn-light btn-sm">Admin Console</a>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div id="importResults" class="p-3"></div>
                                
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th class="fw-semibold sortable" onclick="sortTable('name')">Name <i class="fas fa-sort"></i></th>
                                                <th class="fw-semibold sortable" onclick="sortTable('employee_id')">Employee ID <i class="fas fa-sort"></i></th>
                                                <th class="fw-semibold sortable" onclick="sortTable('role')">Role <i class="fas fa-sort"></i></th>
                                                <th class="fw-semibold sortable" onclick="sortTable('supervisor')">Supervisor <i class="fas fa-sort"></i></th>
                                                <th class="fw-semibold sortable" onclick="sortTable('office')">Office <i class="fas fa-sort"></i></th>
                                                <th class="fw-semibold sortable" onclick="sortTable('department')">Department <i class="fas fa-sort"></i></th>
                                                <th class="fw-semibold sortable" onclick="sortTable('hire_date')">Hire Date <i class="fas fa-sort"></i></th>
                                                <th class="fw-semibold">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="activeEmployeesTableBody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-pane fade" id="terminated-employees" role="tabpanel">
                        <div class="card shadow-sm">
                            <div class="card-header bg-danger text-white">
                                <h5 class="mb-0"><i class="fas fa-user-times me-2"></i>Terminated Employees</h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th class="fw-semibold sortable" onclick="sortTable('name')">Name <i class="fas fa-sort"></i></th>
                                                <th class="fw-semibold sortable" onclick="sortTable('employee_id')">Employee ID <i class="fas fa-sort"></i></th>
                                                <th class="fw-semibold sortable" onclick="sortTable('role')">Role <i class="fas fa-sort"></i></th>
                                                <th class="fw-semibold sortable" onclick="sortTable('office')">Office <i class="fas fa-sort"></i></th>
                                                <th class="fw-semibold sortable" onclick="sortTable('hire_date')">Hire Date <i class="fas fa-sort"></i></th>
                                                <th class="fw-semibold">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="terminatedEmployeesTableBody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Check authentication
        if (sessionStorage.getItem('pandaAdmin') !== 'authenticated') {
            window.location.replace('login.html');
        }
        const API_URL = 'https://4ytrdf6rpklojh5c52gxpf5iei0winqx.lambda-url.us-east-2.on.aws';
        let employees = [];
        let filteredEmployees = [...employees];
        let sortColumn = '';
        let sortDirection = 'asc';

        document.addEventListener('DOMContentLoaded', function() {
            loadEmployees();
        });

        async function loadEmployees() {
            try {
                const response = await fetch(`${API_URL}/employees`);
                employees = await response.json();
                
                // Add default Panda Points fields if missing
                employees = employees.map(emp => ({
                    ...emp,
                    password: emp.password || 'Welcome2025!',
                    points_lifetime: emp.points_lifetime || 0,
                    points_redeemed: emp.points_redeemed || 0,
                    points_balance: emp.points_balance || 0
                }));
                
                filteredEmployees = [...employees];
                displayEmployees();
                populateFilters();
                populateEmployeeSelect();
            } catch (error) {
                console.error('Error loading employees:', error);
                document.getElementById('importResults').innerHTML = 
                    '<div class="alert alert-danger">Failed to load employees. Please check API connection.</div>';
            }
        }

        function populateEmployeeSelect() {
            const select = document.getElementById('employeeSelect');
            const defaultOption = select.querySelector('option[value=""]');
            select.innerHTML = '';
            select.appendChild(defaultOption);
            
            employees.filter(emp => emp.status === 'active').forEach(employee => {
                const option = document.createElement('option');
                option.value = employee.email;
                option.textContent = `${employee.name} - ${employee.role}`;
                select.appendChild(option);
            });
        }

        async function awardPoints() {
            const employeeEmail = document.getElementById('employeeSelect').value;
            const points = parseInt(document.getElementById('pointsAmount').value);
            const reason = document.getElementById('pointsReason').value;
            
            if (!employeeEmail || !points) {
                alert('Please select an employee and enter points amount');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/award-points`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        employee_email: employeeEmail,
                        points: points,
                        reason: reason,
                        manager: 'Rob Winters'
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`Successfully awarded ${points} points!`);
                    document.getElementById('employeeSelect').value = '';
                    document.getElementById('pointsAmount').value = '';
                    document.getElementById('pointsReason').value = '';
                    await loadEmployees();
                } else {
                    alert(`Error: ${result.error}`);
                }
            } catch (error) {
                alert(`Failed to award points: ${error.message}`);
            }
        }

        async function importFromGoogleSheets() {
            try {
                document.getElementById('importResults').innerHTML = 
                    '<div class="alert alert-info">Importing from Google Sheets...</div>';
                
                const response = await fetch(`${API_URL}/import`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    document.getElementById('importResults').innerHTML = 
                        `<div class="alert alert-success">${result.message}</div>`;
                    await loadEmployees(); // Reload data
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                document.getElementById('importResults').innerHTML = 
                    `<div class="alert alert-danger">Import failed: ${error.message}</div>`;
            }
        }

        function displayEmployees() {
            const activeTableBody = document.getElementById('activeEmployeesTableBody');
            const terminatedTableBody = document.getElementById('terminatedEmployeesTableBody');
            
            activeTableBody.innerHTML = '';
            terminatedTableBody.innerHTML = '';
            
            let activeCount = 0;
            let terminatedCount = 0;
            
            filteredEmployees.forEach(employee => {
                const row = createEmployeeRow(employee);
                
                if (employee.status === 'active') {
                    activeTableBody.appendChild(row);
                    activeCount++;
                } else {
                    terminatedTableBody.appendChild(row);
                    terminatedCount++;
                }
            });
            
            document.getElementById('activeCount').textContent = activeCount;
            document.getElementById('terminatedCount').textContent = terminatedCount;
            document.getElementById('totalCount').textContent = activeCount + terminatedCount;
        }

        function createEmployeeRow(employee) {
            const row = document.createElement('tr');
            
            if (employee.status === 'active') {
                row.innerHTML = `
                    <td><strong>${employee.name || ''}</strong><br><small class="text-muted">${employee.email || ''}</small></td>
                    <td>${employee.employee_id || ''}</td>
                    <td>${employee.role || ''}</td>
                    <td>${employee.supervisor || ''}</td>
                    <td>${employee.office || ''}</td>
                    <td>${employee.department || ''}</td>
                    <td>${employee.hire_date || ''}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewEmployee('${employee.email}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
            } else {
                row.innerHTML = `
                    <td><strong>${employee.name || ''}</strong><br><small class="text-muted">${employee.email || ''}</small></td>
                    <td>${employee.employee_id || ''}</td>
                    <td>${employee.role || ''}</td>
                    <td>${employee.office || ''}</td>
                    <td>${employee.hire_date || ''}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewEmployee('${employee.email}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
            }
            
            return row;
        }

        function populateFilters() {
            const offices = [...new Set(employees.map(e => e.office).filter(Boolean))];
            const roles = [...new Set(employees.map(e => e.role).filter(Boolean))];
            
            populateSelect('officeFilter', offices);
            populateSelect('roleFilter', roles);
        }

        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            const allOption = select.querySelector('option[value=""]');
            select.innerHTML = '';
            select.appendChild(allOption);
            
            options.sort().forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
        }

        function filterEmployees() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const officeFilter = document.getElementById('officeFilter').value;
            const roleFilter = document.getElementById('roleFilter').value;
            
            filteredEmployees = employees.filter(employee => {
                const matchesSearch = !searchTerm || 
                    (employee.name && employee.name.toLowerCase().includes(searchTerm)) ||
                    (employee.email && employee.email.toLowerCase().includes(searchTerm)) ||
                    (employee.employee_id && employee.employee_id.toLowerCase().includes(searchTerm));
                
                const matchesOffice = !officeFilter || employee.office === officeFilter;
                const matchesRole = !roleFilter || employee.role === roleFilter;
                
                return matchesSearch && matchesOffice && matchesRole;
            });
            
            displayEmployees();
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('officeFilter').value = '';
            document.getElementById('roleFilter').value = '';
            filteredEmployees = [...employees];
            displayEmployees();
        }

        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            
            filteredEmployees.sort((a, b) => {
                let aVal = a[column] || '';
                let bVal = b[column] || '';
                
                if (sortDirection === 'asc') {
                    return aVal.localeCompare(bVal);
                } else {
                    return bVal.localeCompare(aVal);
                }
            });
            
            displayEmployees();
        }

        function viewEmployee(email) {
            const employee = employees.find(e => e.email === email);
            if (employee) {
                const pointsInfo = `\n\n--- PANDA POINTS ---\nLifetime Total: ${employee.points_lifetime || 0}\nRedeemed: ${employee.points_redeemed || 0}\nCurrent Balance: ${employee.points_balance || 0}\nDefault Password: ${employee.password || 'Welcome2025!'}`;
                alert(`Employee Details:\n\nName: ${employee.name}\nEmployee ID: ${employee.employee_id}\nRole: ${employee.role}\nSupervisor: ${employee.supervisor}\nOffice: ${employee.office}\nDepartment: ${employee.department}\nHire Date: ${employee.hire_date}\nPhone: ${employee.phone}\nEmail: ${employee.email}\nStatus: ${employee.status}${pointsInfo}`);
            }
        }
    </script>
</body>
</html>